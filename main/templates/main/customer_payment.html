{% extends "base.html" %}

{% block title %}Konfirmasi Pembayaran - Booking #{{ booking.id }}{% endblock title %}

{% block content %}
<div class="max-w-3xl mx-auto my-8 bg-white p-6 rounded-lg shadow">
  <h2 class="text-2xl font-semibold mb-6">Konfirmasi Pembayaran</h2>
  <hr class="my-6 border-gray-200">

  {% if transaction.payment_method|default:""|upper == "TRANSFER" %}
    <p class="text-gray-600 mb-4">
      Silakan lakukan transfer sesuai instruksi. Setelah melakukan transfer, tekan tombol "Sudah bayar" untuk mengonfirmasi.
    </p>
    
    <form method="post" class="mt-4" id="payment-form">
      {% csrf_token %}
      <div class="flex gap-3">
        <button type="submit" 
                id="submit-button"
                class="px-4 py-2 bg-green-600 text-white font-semibold rounded hover:bg-green-700 transition-colors">
          Sudah bayar
        </button>
        <a href="{% url 'my_bookings' %}" 
           class="px-4 py-2 bg-gray-600 text-white font-semibold rounded hover:bg-gray-700 transition-colors">
          Kembali
        </a>
      </div>
    </form>
  {% else %}
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const paymentForm = document.getElementById('payment-form');
  const submitButton = document.getElementById('submit-button');

  if (paymentForm) {
    paymentForm.addEventListener('submit', function(e) {
        e.preventDefault(); 
        
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = 'Memproses...';
        }

        const csrfToken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;

        fetch(this.action, {
            method: 'POST',
            body: new FormData(this), 
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            return response.json().then(data => ({ 
                ok: response.ok, 
                data 
            }));
        })
        .then(({ ok, data }) => {
            if (ok) {
                // SUKSES (status 200)
                alert(data.message); 
                window.location.href = data.redirect_url;
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
            
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = 'Sudah bayar';
            }
        });
    });
  }

});
</script>
{% endblock content %}