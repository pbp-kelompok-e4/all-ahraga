{% extends "base.html" %}

{% block title %}Bookingan Saya{% endblock title %}

{% block content %}
<div class="max-w-[900px] mx-auto my-5 p-6 bg-white rounded-lg shadow">
    <h2 class="text-center border-b-2 border-gray-100 pb-4 mb-6 text-xl font-semibold">
        Riwayat Bookingan Saya
    </h2>

    {% if bookings %}
        <ul class="space-y-5">
            {% for booking in bookings %}
                <li class="border border-gray-200 rounded-lg p-5 bg-gray-50">
                    <h4 class="text-lg mb-3">
                        Booking #{{ booking.id }} - 
                        <strong>{{ booking.venue_schedule.venue.name }}</strong>
                    </h4>
                    
                    <p class="mb-2">
                        <strong>Jadwal:</strong> 
                        {{ booking.venue_schedule.date|date:"l, d F Y" }}
                    </p>
                    <p class="mb-2">
                        <strong>Total Biaya:</strong> 
                        <span class="font-medium">Rp {{ booking.total_price }}</span>
                    </p>
                    <p>
                        <strong>Status Pembayaran:</strong> 
                        <span class="{% if booking.transaction.status == 'CONFIRMED' %}text-green-600{% elif booking.transaction.status == 'PENDING' %}text-yellow-600{% else %}text-red-600{% endif %} font-medium"> 
                            {{ booking.transaction.get_status_display|default:booking.transaction.status }}
                        </span>
                    </p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-center text-gray-600">Anda belum memiliki riwayat booking.</p>
    {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchBooking');
    const statusFilter = document.getElementById('statusFilter');
    const bookingList = document.getElementById('bookingList');
    const bookingItems = Array.from(document.querySelectorAll('#bookingList li'));
    const emptyMessage = document.getElementById('emptyMessage');

    function filterBookings() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusTerm = statusFilter.value.toLowerCase();
        let visibleCount = 0;

        bookingItems.forEach(item => {
            const venueName = item.getAttribute('data-venue');
            const status = item.getAttribute('data-status');
            const matchesSearch = venueName.includes(searchTerm);
            const matchesStatus = !statusTerm || status === statusTerm;
            
            if (matchesSearch && matchesStatus) {
                item.classList.remove('hidden');
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        });

        // Show/hide empty message
        if (emptyMessage) {
            emptyMessage.style.display = visibleCount === 0 ? 'block' : 'none';
        }
    }

    // Add event listeners
    if (searchInput) {
        searchInput.addEventListener('input', filterBookings);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterBookings);
    }

    // WebSocket for real-time updates (optional)
    try {
        const bookingSocket = new WebSocket(
            `ws://${window.location.host}/ws/bookings/`
        );

        bookingSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'booking_update') {
                const bookingItem = document.querySelector(`[data-booking-id="${data.booking_id}"]`);
                if (bookingItem) {
                    const statusBadge = bookingItem.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = data.status;
                        statusBadge.className = `status-badge font-medium ${
                            data.status === 'CONFIRMED' ? 'text-green-600' :
                            data.status === 'PENDING' ? 'text-yellow-600' : 
                            'text-red-600'
                        }`;
                    }
                    bookingItem.setAttribute('data-status', data.status.toLowerCase());
                    filterBookings(); // Reapply filters
                }
            }
        };
    } catch (error) {
        console.log('WebSocket connection not available');
    }
});  
</script>
{% endblock content %}