{% extends "base.html" %}

{% block title %}Jadwal Saya{% endblock title %}

{% block content %}
<div style="max-width:1100px;margin:24px auto;">
    <h2>Jadwal Sesi â€” {{ request.user.get_full_name|default:request.user.username }}</h2>
    <p style="color:#666;">Atur jadwal yang bisa Anda layani. Masukkan tanggal dan rentang jam, sistem akan membuat slot per jam.</p>

    <div style="display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px;">
        <div style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e9ecef;">
            <h3 style="margin-top:0;display:flex;justify-content:space-between;align-items:center;">
                <span>Daftar Jadwal</span>
                <!-- bulk delete form -->
                <form method="post" action="{% url 'coach_schedule_delete' %}" id="bulk-delete-form" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit" style="background:#dc3545;color:white;border:none;padding:6px 10px;border-radius:6px;font-weight:600;cursor:pointer;">Hapus terpilih</button>
                </form>
            </h3>

            {% regroup schedules by date as grouped_schedules %}
            {% if grouped_schedules %}
                {% for group in grouped_schedules %}
                    <div style="margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>{{ group.grouper|date:"l, d M Y" }}</strong>
                            <small style="color:#666;">{{ group.list|length }} slot{% if group.list|length > 1 %}s{% endif %}</small>
                        </div>
                        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                            {% for s in group.list %}
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <!-- checkbox must be inside the bulk delete form, so duplicate input via JS on submit -->
                                    <input type="checkbox" class="delete-checkbox" data-id="{{ s.id }}" />
                                    {% if s.is_booked %}
                                        <span style="padding:6px 10px;border-radius:999px;background:#fff5f5;color:#c82333;border:1px solid rgba(220,53,69,0.08);font-size:0.9rem;text-decoration:line-through;">
                                            {{ s.start_time|time:"H:i" }} - {{ s.end_time|time:"H:i" }}
                                        </span>
                                    {% else %}
                                        <span style="padding:6px 10px;border-radius:999px;background:#e9f7ef;color:#155724;border:1px solid rgba(25,135,84,0.12);font-size:0.9rem;">
                                            {{ s.start_time|time:"H:i" }} - {{ s.end_time|time:"H:i" }}
                                        </span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="color:#666;">Belum ada jadwal. Tambahkan jadwal di panel sebelah kanan.</p>
            {% endif %}
        </div>

        <div style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e9ecef;">
            <h3 style="margin-top:0;">Tambah Jadwal Baru</h3>
            <form method="post">
                {% csrf_token %}
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <div>
                        <label><strong>Tanggal</strong></label><br>
                        {{ form.date }}
                    </div>
                    <div>
                        <label><strong>Mulai</strong></label><br>
                        {{ form.start_time }}
                    </div>
                    <div>
                        <label><strong>Selesai</strong></label><br>
                        {{ form.end_time }}
                    </div>
                    <div>
                        <label><strong>Available</strong></label><br>
                        {{ form.is_available }}
                    </div>
                    <div style="margin-top:8px;">
                        <button type="submit" style="width:100%;padding:10px;background:#198754;border:none;color:white;border-radius:6px;font-weight:700;">Tambah Jadwal per jam</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// saat submit bulk-delete form, tambah input hidden untuk setiap checkbox terpilih
document.addEventListener('DOMContentLoaded', function(){
    const deleteForm = document.getElementById('bulk-delete-form');
    if (!deleteForm) return;
    deleteForm.addEventListener('submit', function(e){
        // hapus sebelumnya
        Array.from(deleteForm.querySelectorAll('input[name="selected_schedules"]')).forEach(n => n.remove());
        // ambil semua checkbox yang dicentang
        const checked = document.querySelectorAll('.delete-checkbox:checked');
        if (checked.length === 0){
            e.preventDefault();
            alert('Pilih minimal satu jadwal untuk dihapus.');
            return;
        }
        checked.forEach(ch => {
            const hid = document.createElement('input');
            hid.type = 'hidden';
            hid.name = 'selected_schedules';
            hid.value = ch.getAttribute('data-id');
            deleteForm.appendChild(hid);
        });
    });
});
</script>
{% endblock content %}