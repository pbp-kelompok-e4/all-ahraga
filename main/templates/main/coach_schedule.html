{% extends "base_dashboard.html" %}

{% block title %}Jadwal Sesi Anda{% endblock title %}

{% block page_title %}
  Jadwal Kamu
{% endblock page_title %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
/* Styling Checkbox Delete */
.delete-checkbox { display: none; margin-right: 0.5rem; width: auto !important; vertical-align: middle;}
.selection-active .delete-checkbox { display: inline-block; }

/* Styling Slot Terpilih */
.slot-card.selected {
  border-color: #ef4444 !important;      /* red-500 */
  background-color: #fef2f2 !important;  /* red-50 */
  color: #b91c1c !important;             /* red-800 */
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}
.selection-active .slot-label:hover .slot-card.available {
    background-color: #f0fdfa; /* teal-50 */
}

/* Styling Toast */
#custom-toast {
    position: fixed; bottom: 20px; right: 20px;
    min-width: 280px; padding: 12px 18px; border-radius: 0.75rem;
    color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
    z-index: 10000; transition: all 0.3s ease-out;
    transform: translateX(120%); opacity: 0;
    display: flex; align-items: center; gap: 10px;
}
.show-toast {
    transform: translateX(0) !important;
    opacity: 1 !important;
}

/* Styling Input Flatpickr */
input.datepicker, input.timepicker {
    background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937;
    border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    width: auto; min-width: 150px;
}
input.datepicker:focus, input.timepicker:focus {
    outline: none; border-color: #14b8a6; box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
}

/* Styling Modal Profile (Khusus Profile) */
.modal-overlay { display: none; }
.modal-open { display: flex !important; animation: fadeIn 0.3s ease forwards; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
.animate-slideUp { animation: slideUp 0.3s ease forwards; }
</style>
{% endblock extra_head %}


{% block content %}

{# --- KONDISI 1: PROFIL BELUM LENGKAP --- #}
{% if not has_profile %}
  <div class="bg-white rounded-xl shadow-lg p-8 sm:p-12 text-center max-w-3xl mx-auto border border-gray-100">
    <div class="text-6xl mb-6 text-teal-500"><i class="fa-solid fa-clipboard-question"></i></div>
    <h2 class="text-2xl font-bold text-slate-800 mb-3">Profil Belum Lengkap</h2>
    <p class="text-slate-600 mb-6">Anda perlu melengkapi profil pelatih terlebih dahulu sebelum dapat mengatur jadwal ketersediaan.</p>
    <button onclick="showProfileModal()" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-teal-600 to-teal-800 text-white rounded-lg shadow hover:from-teal-700 hover:to-teal-900 transition font-semibold">
      <i class="fa-solid fa-user-pen"></i>
      Kelola Profil Sekarang
    </button>
    <div class="mt-8 pt-6 border-t border-gray-100">
      <p class="text-sm text-gray-500"><i class="fa-solid fa-lightbulb mr-1 text-yellow-500"></i> Setelah melengkapi profil, Anda dapat mengatur jadwal di halaman ini.</p>
    </div>
  </div>

{# --- KONDISI 2: PROFIL SUDAH LENGKAP (TAMPILKAN JADWAL) --- #}
{% else %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 space-y-6">
      <div class="bg-white border border-gray-100 rounded-xl p-5 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-2 flex-wrap">
            <label for="filter-date" class="text-sm font-medium text-gray-600 flex-shrink-0">Tampilkan:</label>
            <input id="filter-date" type="text" class="datepicker" placeholder="Pilih tanggal" />
            <button id="apply-filter" class="px-3 py-2 bg-teal-700 text-white hover:bg-teal-800 rounded-lg text-sm font-medium transition shadow-sm">Terapkan</button>
            <button id="clear-filter" class="px-3 py-2 bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-lg text-sm hidden">Semua</button>
          </div>

          {# Form ini digunakan URL-nya untuk fetch delete #}
          <form method="post" action="{% url 'coach_schedule_delete' %}" id="bulk-delete-form" class="flex-shrink-0">
            {% csrf_token %}
            <div class="flex items-center gap-3">
              <button type="button" id="delete-toggle-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium text-sm shadow-sm flex items-center gap-1">
                 <i class="fa-solid fa-trash-can"></i>
                <span id="delete-toggle-text">Hapus Jadwal</span>
              </button>
              <div id="delete-controls-container" class="hidden flex items-center gap-3">
                  <button type="button" id="select-all" class="px-3 py-2 bg-slate-100 border border-slate-300 rounded-lg text-sm text-slate-700 hover:bg-slate-200">Pilih Semua</button>
                  <button type="button" id="cancel-delete-btn" class="px-3 py-2 bg-gray-200 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-300">Batal</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="space-y-6" id="schedules-list-container">
        {% if schedules %}
          {% regroup schedules by date as grouped_schedules %}
          {% for group in grouped_schedules %}
            <div class="bg-white border border-gray-100 rounded-xl p-5 shadow-sm group" data-date="{{ group.grouper|date:'Y-m-d' }}">
              <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
                <div>
                  <h3 class="text-lg font-semibold text-slate-800">{{ group.grouper|date:"l, d M Y" }}</h3>
                  <p class="text-sm text-gray-500 mt-0.5 slot-count">{{ group.list|length }} slot</p>
                </div>
              </div>
              <div class="flex flex-wrap gap-3 slot-container">
                {% for s in group.list %}
                  <label class="relative inline-flex items-center slot-label">
                    <input type="checkbox" class="delete-checkbox form-checkbox h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" data-id="{{ s.id }}" {% if s.is_booked %}disabled{% endif %} />
                    {% if s.is_booked %}
                      <span class="slot-card booked inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed line-through shadow-sm" title="Slot ini sudah dibooking">
                        <i class="fa-solid fa-lock h-4 w-4 icon text-gray-400"></i>
                        <span class="text-sm font-medium">{{ s.start_time|time:"H:i" }} - {{ s.end_time|time:"H:i" }}</span>
                        <span class="ml-1 text-xs font-semibold">(BOOKED)</span>
                      </span>
                    {% else %}
                      <span class="slot-card available inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 cursor-pointer hover:border-teal-600 hover:bg-teal-50 shadow-sm transition-colors duration-150">
                        <i class="fa-solid fa-check h-4 w-4 icon text-teal-600"></i>
                        <span class="text-sm font-medium">{{ s.start_time|time:"H:i" }} - {{ s.end_time|time:"H:i" }}</span>
                      </span>
                    {% endif %}
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="bg-white border border-dashed border-gray-300 rounded-xl p-8 shadow-sm text-center" id="no-schedule-message">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <h3 class="text-lg font-medium text-slate-900">Belum ada jadwal</h3>
            <p class="mt-1 text-sm text-gray-500">Tambahkan jadwal ketersediaan Anda menggunakan form di samping.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <aside class="lg:col-span-1">
      <div class="sticky top-24 bg-white border-t-4 border-teal-700 rounded-xl shadow-lg">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-slate-800 mb-2 flex items-center gap-2"><i class="fa-solid fa-calendar-plus text-teal-600"></i> Tambah Jadwal Baru</h3>
          <p class="text-sm text-gray-500 mb-5">Pilih tanggal dan rentang waktu. Slot akan dibuat per jam.</p>

          <form method="post" class="space-y-4" id="add-schedule-form" action="{% url 'coach_schedule' %}">
            {% csrf_token %}
            
            <div>
              <label for="{{ form.date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.date.label }}</label>
              {{ form.date }} 
              {% if form.date.errors %}<div class="text-red-500 text-sm mt-1">{{ form.date.errors.0 }}</div>{% endif %}
            </div>
            <div>
              <label for="{{ form.start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.start_time.label }}</label>
              {{ form.start_time }} 
              {% if form.start_time.errors %}<div class="text-red-500 text-sm mt-1">{{ form.start_time.errors.0 }}</div>{% endif %}
            </div>
            <div>
              <label for="{{ form.end_time_global.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.end_time_global.label }}</label>
              {{ form.end_time_global }}
              {% if form.end_time_global.errors %}<div class="text-red-500 text-sm mt-1">{{ form.end_time_global.errors.0 }}</div>{% endif %}
            </div>

            <div class="pt-2">
              <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-teal-700 text-white rounded-lg hover:bg-teal-800 transition font-semibold shadow-sm">
                <i class="fa-solid fa-plus h-5 w-5"></i>
                Tambah Jadwal
              </button>
            </div>
          </form>
        </div>
      </div>
    </aside>
  </div>

  {# --- MODAL KONFIRMASI DELETE (Hanya render jika ada profil) --- #}
  <div id="delete-modal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-200">
          <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                <i class="fa-solid fa-triangle-exclamation text-red-600"></i>
              </div>
              <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Hapus Jadwal</h3>
                <div class="mt-2">
                  <p class="text-sm text-gray-500" id="modal-message">
                    Apakah Anda yakin ingin menghapus jadwal yang dipilih? Tindakan ini tidak dapat dibatalkan.
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
            <button type="button" id="confirm-delete-btn" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto transition">
              Ya, Hapus
            </button>
            <button type="button" id="cancel-modal-btn" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition">
              Batal
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endif %} {# Akhir if not has_profile #}

{# --- ELEMEN GLOBAL (TOAST & PROFILE MODAL) --- #}
<div id="custom-toast" role="status" aria-live="polite">
    <span id="toast-icon"></span>
    <span id="toast-message" class="ml-2"></span>
</div>

{% if not has_profile %}
<div id="profileModal" class="modal-overlay fixed inset-0 z-[9999] items-center justify-center bg-black/60 p-4 backdrop-blur-sm">
  <div class="modal-content bg-white rounded-2xl max-w-2xl w-full shadow-2xl overflow-hidden max-h-[90vh] flex flex-col animate-slideUp"> 
    <button class="modal-close absolute top-3 right-3 z-10 p-2 rounded-full text-gray-500 bg-gray-100 hover:bg-gray-200 hover:text-gray-700 transition-colors" onclick="hideProfileModal()"><i class="fa-solid fa-xmark text-xl"></i></button>
    <div class="modal-header bg-gradient-to-r from-teal-700 to-teal-800 p-6 text-center flex items-center justify-center gap-3">
        <i class="fa-solid fa-user-pen text-white text-2xl"></i>
        <h2 class="text-xl font-semibold text-white">Kelola Profil Pelatih</h2>
    </div>
    <div id="profileFormContainer" class="modal-body p-6 overflow-y-auto flex-1">
      <div class="text-center text-slate-600 py-16 flex flex-col items-center"><div class="text-4xl mb-3 animate-spin text-teal-600"><i class="fa-solid fa-spinner"></i></div>Memuat formulir...</div>
    </div>
  </div>
</div>
{% endif %}

{% endblock content %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// --- UTILITIES (getCookie, showToast) ---
function getCookie(name) { let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)'); return v ? v[2] : null; }
function showToast(message, type = 'success') {
    const toast = document.getElementById('custom-toast');
    if (!toast) return; 
    const msgEl = document.getElementById('toast-message');
    const iconEl = document.getElementById('toast-icon');
    let color = type === 'success' ? '#10b981' : (type === 'error' ? '#ef4444' : '#f97316');
    let icon = type === 'success' ? '✅' : (type === 'error' ? '❌' : '⚠️');
    toast.style.backgroundColor = color;
    msgEl.textContent = message;
    iconEl.textContent = icon;
    toast.classList.add('show-toast');
    setTimeout(() => toast.classList.remove('show-toast'), 3000);
}

// --- HELPERS (createSlotHtml, createGroupCardHtmlForAjax) ---
function createSlotHtml(slot) { 
    return `
    <label class="relative inline-flex items-center slot-label">
        <input type="checkbox" class="delete-checkbox form-checkbox h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" data-id="${slot.id}" />
        <span class="slot-card available inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 cursor-pointer hover:border-teal-600 hover:bg-teal-50 shadow-sm transition-colors duration-150">
            <i class="fa-solid fa-check h-4 w-4 icon text-teal-600"></i>
            <span class="text-sm font-medium">${slot.start_time} - ${slot.end_time}</span>
        </span>
    </label>`;
 }
function createGroupCardHtmlForAjax(firstSlot, allSlots) {
     let slotsHtml = allSlots.map(createSlotHtml).join('');
     const count = allSlots.length;
     const slotText = count !== 1 ? 'slots' : 'slot';
     return `
     <div class="bg-white border border-gray-100 rounded-xl p-5 shadow-sm group" data-date="${firstSlot.date_str_iso}">
         <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
             <div><h3 class="text-lg font-semibold text-slate-800">${firstSlot.date_str_display}</h3><p class="text-sm text-gray-500 mt-0.5 slot-count">${count} ${slotText}</p></div>
         </div>
         <div class="flex flex-wrap gap-3 slot-container">${slotsHtml}</div>
     </div>`;
}

// --- MAIN LOGIC ---
document.addEventListener('DOMContentLoaded', function(){
    // Flatpickr Initialization
    flatpickr(".datepicker", { altInput: true, altFormat: "d M Y", dateFormat: "Y-m-d", minDate: "today" });
    flatpickr(".timepicker", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, minuteIncrement: 60 });

    // Element References
    const filter = document.getElementById('filter-date');
    const applyBtn = document.getElementById('apply-filter');
    const clearBtn = document.getElementById('clear-filter');
    const bodyEl = document.body;
    
    // Delete & Modal Elements
    const deleteToggleBtn = document.getElementById('delete-toggle-btn');
    const deleteToggleText = document.getElementById('delete-toggle-text'); 
    const cancelBtn = document.getElementById('cancel-delete-btn');
    const selectAllBtn = document.getElementById('select-all');
    const bulkForm = document.getElementById('bulk-delete-form');
    const deleteControlsContainer = document.getElementById('delete-controls-container');
    const scheduleListContainer = document.getElementById('schedules-list-container');
    
    // Add Form
    const addScheduleForm = document.getElementById('add-schedule-form');

    // Modal Delete Elements
    const deleteModal = document.getElementById('delete-modal');
    const modalMessage = document.getElementById('modal-message');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelModalBtn = document.getElementById('cancel-modal-btn');

    let selectionActive = false;
    let idsToDeletePending = []; // Menyimpan ID sementara

    // --- AJAX: Add Schedule (TETAP POST) ---
    addScheduleForm?.addEventListener('submit', async function(e){
        e.preventDefault();
        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        if (submitButton) submitButton.disabled = true;

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken')}
            });
            const data = await response.json(); 

            if (!response.ok) {
                 throw new Error(data.message || (data.errors ? Object.values(data.errors).flat().join('; ') : `HTTP error ${response.status}`));
            }
            
            showToast(data.message || 'Jadwal ditambahkan!', 'success');
            if (data.new_slots && data.new_slots.length > 0) {
                const noScheduleMsg = document.getElementById('no-schedule-message');
                if (noScheduleMsg) noScheduleMsg.remove();
                
                 const slotsByDate = data.new_slots.reduce((acc, slot) => {
                    const date = slot.date_str_iso;
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(slot);
                    return acc;
                 }, {});
                
                 for (const dateISO in slotsByDate) {
                     const slotsForThisDate = slotsByDate[dateISO];
                     if (slotsForThisDate.length === 0) continue;
                     const firstSlot = slotsForThisDate[0];
                     let groupCard = scheduleListContainer.querySelector(`.group[data-date="${dateISO}"]`);
                     
                     if (groupCard) { // Update existing group
                         const slotContainer = groupCard.querySelector('.slot-container');
                         if (slotContainer) {
                             let slotsHtml = slotsForThisDate.map(createSlotHtml).join('');
                             slotContainer.insertAdjacentHTML('beforeend', slotsHtml);
                             const countEl = groupCard.querySelector('.slot-count');
                             if (countEl) {
                                 const newCount = slotContainer.children.length; // Hitung children
                                 countEl.textContent = `${newCount} ${newCount !== 1 ? 'slots' : 'slot'}`;
                             }
                         }
                     } else { // Insert new group
                         const newGroupHtml = createGroupCardHtmlForAjax(firstSlot, slotsForThisDate);
                         const tempDiv = document.createElement('div'); tempDiv.innerHTML = newGroupHtml.trim();
                         const newGroupCard = tempDiv.firstChild;
                         const allCards = Array.from(scheduleListContainer.querySelectorAll('.group[data-date]'));
                         let inserted = false;
                         for (let i = 0; i < allCards.length; i++) {
                             if (dateISO < allCards[i].dataset.date) {
                                 scheduleListContainer.insertBefore(newGroupCard, allCards[i]); inserted = true; break;
                             }
                         }
                         if (!inserted) scheduleListContainer.appendChild(newGroupCard);
                     }
                 }
            }
            addScheduleForm.reset();
            document.querySelectorAll('.datepicker, .timepicker').forEach(fpInput => { if (fpInput._flatpickr) fpInput._flatpickr.clear(); });
        } catch (error) { 
            console.error('Add Schedule Error:', error);
            showToast(error.message || 'Gagal menambahkan jadwal.', 'error');
        } finally {
            if (submitButton) submitButton.disabled = false;
        }
    });

    // --- FUNCTION: MODAL DELETE ---
    function showDeleteModal(count) {
        if(modalMessage) modalMessage.textContent = `Apakah Anda yakin ingin menghapus ${count} jadwal yang dipilih? Tindakan ini tidak dapat dibatalkan.`;
        if(deleteModal) deleteModal.classList.remove('hidden');
    }
    function hideDeleteModal() {
        if(deleteModal) deleteModal.classList.add('hidden');
        idsToDeletePending = [];
    }
    if(cancelModalBtn) cancelModalBtn.addEventListener('click', hideDeleteModal);

    // --- STEP 1: TOMBOL HAPUS (BUKA MODAL) ---
    deleteToggleBtn?.addEventListener('click', function(){
        if (!selectionActive) { enterSelectionMode(); return; }

        const checkedCheckboxes = Array.from(scheduleListContainer.querySelectorAll('.delete-checkbox:checked:not(:disabled)'));
        if (checkedCheckboxes.length === 0) { showToast('Pilih jadwal untuk dihapus.', 'warning'); return; }
        
        // Simpan ID sementara
        idsToDeletePending = checkedCheckboxes.map(ch => ch.dataset.id);
        
        // Buka Modal
        showDeleteModal(checkedCheckboxes.length);
    });

    // --- STEP 2: TOMBOL YA HAPUS (EKSEKUSI DELETE) ---
    confirmDeleteBtn?.addEventListener('click', function() {
        // UI Feedback
        const originalText = confirmDeleteBtn.textContent;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = 'Menghapus...';

        fetch(bulkForm.action, {
            method: 'DELETE', // <-- GANTI JADI DELETE
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest'},
            body: JSON.stringify({ selected_schedules: idsToDeletePending })
        })
        .then(res => res.ok ? res.json() : res.json().then(err => { throw err; })) 
        .then(data => {
            if (data.success) {
                showToast(data.message || 'Jadwal dihapus!', 'success');
                
                // Update DOM
                idsToDeletePending.forEach(id => {
                    const checkbox = scheduleListContainer.querySelector(`.delete-checkbox[data-id="${id}"]`);
                    const label = checkbox?.closest('label.slot-label');
                    const groupContainer = label?.parentElement;
                    const card = groupContainer?.closest('.group[data-date]');
                    label?.remove();
                    
                    if (card && groupContainer?.children.length === 0) { 
                        card.remove(); 
                    } else if (card) { // Update count
                        const countEl = card.querySelector('.slot-count');
                        const newCount = groupContainer.children.length;
                        if(countEl) countEl.textContent = `${newCount} ${newCount !== 1 ? 'slots' : 'slot'}`;
                    }
                });

                if (scheduleListContainer.querySelectorAll('.group[data-date]').length === 0 && !document.getElementById('no-schedule-message')) {
                    scheduleListContainer.innerHTML = `<div class="bg-white border border-dashed border-gray-300 rounded-xl p-8 shadow-sm text-center" id="no-schedule-message"><svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><h3 class="text-lg font-medium text-slate-900">Belum ada jadwal</h3><p class="mt-1 text-sm text-gray-500">Tambahkan jadwal ketersediaan Anda.</p></div>`;
                }

                hideDeleteModal();
                exitSelectionMode();
            } else {
                throw new Error(data.message || 'Gagal menghapus jadwal.');
            }
        })
        .catch(error => { 
             console.error("Delete Error:", error);
             showToast(error.message || 'Kesalahan koneksi saat menghapus.', 'error');
             hideDeleteModal();
        })
        .finally(() => {
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.textContent = originalText;
        });
    });

    // --- Filter Logic ---
    function applyFilterValue(val) {
        const allGroups = scheduleListContainer.querySelectorAll('.group[data-date]');
        let visibleCount = 0;
        allGroups.forEach(g => {
            const shouldShow = (!val || g.dataset.date === val);
            g.style.display = shouldShow ? '' : 'none';
            if (shouldShow) visibleCount++;
        });
        const noScheduleMsg = document.getElementById('no-schedule-message');
        if (visibleCount === 0 && !noScheduleMsg) {
             scheduleListContainer.innerHTML = `<div class="bg-white border border-dashed border-gray-300 rounded-xl p-8 shadow-sm text-center" id="no-schedule-message"><svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><h3 class="text-lg font-medium text-slate-900">Tidak ada jadwal</h3><p class="mt-1 text-sm text-gray-500">Tidak ada jadwal ditemukan untuk tanggal ini.</p></div>`;
        } else if (visibleCount > 0 && noScheduleMsg) {
             noScheduleMsg.remove();
        }
    }
    applyBtn?.addEventListener('click', function(){ const v = filter.value; applyFilterValue(v); clearBtn?.classList.toggle('hidden', !v); });
    clearBtn?.addEventListener('click', function(){ filter.value=''; if(filter._flatpickr) filter._flatpickr.clear(); applyFilterValue(''); clearBtn?.classList.add('hidden'); const noMsg = document.getElementById('no-schedule-message'); if(noMsg && scheduleListContainer.querySelectorAll('.group[data-date]').length > 0) noMsg.remove(); });

    // --- Selection Mode Logic ---
     function enterSelectionMode() {
        selectionActive = true;
        bodyEl.classList.add('selection-active');
        if(deleteToggleText) deleteToggleText.textContent = 'Hapus';
        deleteToggleBtn?.classList.remove('bg-red-600','hover:bg-red-700');
        deleteToggleBtn?.classList.add('bg-blue-600','hover:bg-blue-700');
        deleteControlsContainer?.classList.remove('hidden');
        scheduleListContainer.querySelectorAll('.delete-checkbox:not(:disabled)').forEach(cb => cb.addEventListener('change', onCheckboxChange));
    }
    function exitSelectionMode() {
        selectionActive = false;
        bodyEl.classList.remove('selection-active');
        if(deleteToggleText) deleteToggleText.textContent = 'Hapus Jadwal';
        deleteToggleBtn?.classList.add('bg-red-600','hover:bg-red-700');
        deleteToggleBtn?.classList.remove('bg-blue-600','hover:bg-blue-700');
        deleteControlsContainer?.classList.add('hidden');
        scheduleListContainer.querySelectorAll('.delete-checkbox').forEach(cb => {
            cb.checked = false;
            cb.removeEventListener('change', onCheckboxChange);
            cb.closest('label')?.querySelector('.slot-card')?.classList.remove('selected');
        });
    }
    function onCheckboxChange(e) { e.target.closest('label')?.querySelector('.slot-card')?.classList.toggle('selected', e.target.checked); }
    
    cancelBtn?.addEventListener('click', exitSelectionMode);
    
    selectAllBtn?.addEventListener('click', function(){
        const visibleCheckboxes = Array.from(scheduleListContainer.querySelectorAll('.delete-checkbox:not(:disabled)')).filter(c => c.closest('.group[data-date]')?.style.display !== 'none'); 
        const shouldSelectAll = !visibleCheckboxes.every(c => c.checked); 
        visibleCheckboxes.forEach(c => { 
            if(c.checked !== shouldSelectAll) { 
                c.checked = shouldSelectAll; 
                c.dispatchEvent(new Event('change')); 
            } 
        });
    });


    // Initial state
    exitSelectionMode();

    // --- PROFILE MODAL LOGIC (TETAP ADA) ---
    {% if not has_profile %}
    const profileModal = document.getElementById('profileModal');
    const profileFormContainer = document.getElementById('profileFormContainer');

    window.showProfileModal = function() {
      if(profileModal) profileModal.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      loadProfileForm();
    }

    window.hideProfileModal = function() {
      if(profileModal) profileModal.classList.remove('modal-open');
      document.body.style.overflow = 'auto';
    }

    function loadProfileForm() {
        if (!profileFormContainer) return;
        profileFormContainer.innerHTML = '<div class="text-center text-slate-600 py-16 flex flex-col items-center"><div class="text-4xl mb-3 animate-spin text-teal-600"><i class="fa-solid fa-spinner"></i></div>Memuat formulir...</div>';

        fetch("{% url 'get_coach_profile_form_ajax' %}")
            .then(response => response.text())
            .then(html => {
                profileFormContainer.innerHTML = html;
                attachProfileFormHandler();
            })
            .catch(error => {
                console.error("Error loading profile form:", error);
                profileFormContainer.innerHTML = '<div class="text-center text-red-600 p-8">' +
                    '<div class="text-4xl mb-3"><i class="fa-solid fa-circle-exclamation"></i></div>' +
                    '<p class="font-semibold">Gagal memuat formulir.</p>' +
                    '<p class="text-sm">Silakan coba lagi.</p>' +
                    '<button onclick="loadProfileForm()" class="mt-4 px-4 py-2 bg-teal-700 text-white rounded-lg hover:bg-teal-800 transition">Coba Lagi</button>' +
                    '</div>';
            });
    }

    function attachProfileFormHandler() {
        const form = document.getElementById('coachProfileForm');
        if (!form) return;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            if(!submitBtn) return;
            
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner animate-spin h-5 w-5 mr-2"></i> Menyimpan...';
            
            document.querySelectorAll('.form-field-error').forEach(el => { el.style.display = 'none'; el.textContent = ''; });
            const formErrors = document.getElementById('formErrors');
            if (formErrors) formErrors.style.display = 'none';
            
            const formData = new FormData(form);
            const csrftoken = getCookie('csrftoken');
            
            fetch("{% url 'save_coach_profile_ajax' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideProfileModal();
                    showToast(data.message || 'Profil berhasil disimpan!', 'success');
                    setTimeout(() => { window.location.reload(); }, 1500);
                } else {
                    displayProfileFormErrors(data.errors);
                    showToast(data.message || 'Gagal menyimpan, periksa error.', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving profile:', error);
                showToast('Terjadi kesalahan saat menyimpan profil', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }

    function displayProfileFormErrors(errors) {
        const errorSummary = document.getElementById('formErrors'); 
        const errorList = document.getElementById('errorList'); 
        if (errorList) errorList.innerHTML = '';
        
        for (const [field, messages] of Object.entries(errors)) {
             messages.forEach(msg => {
                if (errorList) {
                    const li = document.createElement('li'); li.textContent = msg; errorList.appendChild(li);
                }
            });
            const fieldInput = document.getElementById('id_' + field);
            if (fieldInput) {
                const formGroup = fieldInput.closest('div');
                if (formGroup) {
                    let errorSpan = formGroup.querySelector('.form-field-error');
                    if (!errorSpan) {
                        errorSpan = document.createElement('div');
                        errorSpan.className = 'form-field-error text-red-500 text-sm mt-1'; 
                        fieldInput.parentNode.appendChild(errorSpan);
                    }
                    errorSpan.textContent = messages.join(', ');
                    errorSpan.style.display = 'block';
                }
            }
        }
        if (errorSummary && errorList && errorList.children.length > 0) { errorSummary.style.display = 'block'; }
    }

    if (profileModal) {
        profileModal.addEventListener('click', function(e){ if (e.target === profileModal) hideProfileModal(); });
    }
    {% endif %}

});
</script>
{% endblock extra_js %}