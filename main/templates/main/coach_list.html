{% extends "base_dashboard.html" %}

{% block title %}Daftar Pelatih{% endblock title %}

{% block page_title %}
  Daftar Pelatih
{% endblock page_title %}

{% block extra_head %}
<style>
  /* Class for loading state from JS */
  #coach-list-container.loading {
    opacity: 0.5;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  
  /* Modal Animation */
  .modal:not(.hidden) {
    display: flex;
    animation: fadeIn 0.3s ease forwards;
  }
  
  .modal-content {
    opacity: 0;
    transform: translateY(30px);
    animation: slideUp 0.3s ease forwards;
  }

  @keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
  }
  
  @keyframes slideUp { 
    from { opacity: 0; transform: translateY(30px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  
  /* Mobile Optimizations */
  @media (max-width: 640px) {
    .filter-box {
      padding: 1rem !important;
      margin-bottom: 1.5rem !important;
    }
    
    .modal {
      align-items: flex-start;
      padding-top: 1rem;
    }
    
    .modal-content {
      margin: 0.5rem;
      max-height: 90vh !important;
      border-radius: 1rem !important;
    }
    
    /* Fix untuk scroll di dalam modal */
    #modal-body {
      max-height: calc(90vh - 3rem);
    }
  }
</style>
{% endblock extra_head %}


{% block content %}

<div class="filter-box bg-white p-4 sm:p-6 rounded-xl mb-6 sm:mb-8 shadow-lg border border-gray-100">
  <form id="filter-form" class="filter-form w-full">
    <div class="filter-controls grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 items-end">
      
      <input 
        type="text" 
        name="q" 
        placeholder="Cari nama pelatih..."
        value="{{ request.GET.q }}" 
        class="search-input w-full p-2.5 sm:p-3 border border-gray-300 rounded-lg text-sm transition-all duration-300 focus:outline-none focus:border-teal-600 focus:ring-2 focus:ring-teal-100 bg-gray-50 focus:bg-white"
      >
     
      <select 
        name="sport" 
        class="filter-select w-full p-2.5 sm:p-3 border border-gray-300 rounded-lg text-sm transition-all duration-300 focus:outline-none focus:border-teal-600 focus:ring-2 focus:ring-teal-100 bg-gray-50 focus:bg-white"
      >
        <option value="">-- Semua Olahraga --</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if request.GET.sport == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>

      <select 
        name="area" 
        class="filter-select w-full p-2.5 sm:p-3 border border-gray-300 rounded-lg text-sm transition-all duration-300 focus:outline-none focus:border-teal-600 focus:ring-2 focus:ring-teal-100 bg-gray-50 focus:bg-white"
      >
        <option value="">-- Semua Area --</option>
        {% for area in areas %}
          <option value="{{ area.id }}" {% if request.GET.area == area.id|stringformat:"s" %}selected{% endif %}>
            {{ area.name }}
          </option>
        {% endfor %}
      </select>
     
      <a 
        href="{% url 'coach_list' %}" 
        class="reset-button w-full text-center px-4 sm:px-5 py-2.5 sm:py-3 bg-gray-500 text-white rounded-lg text-sm font-semibold transition-all duration-300 hover:bg-gray-600 active:scale-95"
      >
        Reset Filter
      </a>
    </div>
  </form>
</div>

<div id="coach-list-container">
  {% include "main/coach_list_partial.html" %}
</div>

<div 
  id="detailModal" 
  class="modal hidden fixed inset-0 bg-black bg-opacity-60 z-[9998] items-center justify-center p-2 sm:p-4 overflow-y-auto backdrop-blur-sm"
>
  <div 
    id="detailModalContent" 
    class="modal-content bg-white rounded-xl sm:rounded-2xl max-w-xl w-full shadow-2xl relative max-h-[90vh] flex flex-col opacity-0 transform -translate-y-8 transition-all duration-300 ease-out"
  >
    <button 
      id="closeDetailModal" 
      class="close-modal-btn absolute top-2 right-2 sm:top-3 sm:right-3 z-10 p-2 rounded-full text-gray-500 bg-gray-100 hover:bg-gray-200 hover:text-gray-700 transition-colors active:scale-95"
      aria-label="Tutup modal"
    >
      <i class="fa-solid fa-xmark text-lg sm:text-xl"></i>
    </button>
   
    <div id="modal-body" class="modal-body overflow-y-auto flex-1">
      <div 
        id="modal-spinner" 
        class="modal-spinner p-6 sm:p-10 text-center text-gray-600 flex flex-col items-center justify-center min-h-[200px]"
      >
        <div class="text-3xl sm:text-4xl mb-3 sm:mb-4 animate-spin text-teal-600">
          <i class="fa-solid fa-spinner"></i>
        </div>
        <span class="text-sm sm:text-base">Memuat detail pelatih...</span>
      </div>
    </div>
  </div>
</div>

{% endblock content %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterForm = document.getElementById('filter-form');
  const coachListContainer = document.getElementById('coach-list-container');
  const modal = document.getElementById('detailModal');
  const modalContent = document.getElementById('detailModalContent'); 
  const modalBody = document.getElementById('modal-body');
  const modalSpinner = document.getElementById('modal-spinner');
  const closeModalBtn = document.getElementById('closeDetailModal');
 
  const filterUrl = "{% url 'filter_coaches_ajax' %}";

  // --- 1. FETCH COACHES FUNCTION ---
  function fetchCoaches(url) {
    coachListContainer.classList.add('loading');
   
    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      if (data.html !== undefined) {
        coachListContainer.innerHTML = data.html;
         
        // Update browser URL
        const currentUrl = new URL(window.location);
        const newParams = new URLSearchParams(url.split('?')[1] || '');
          
        newParams.forEach((value, key) => {
          if (!value) newParams.delete(key);
        });

        currentUrl.search = newParams.toString();
        window.history.pushState({ path: currentUrl.toString() }, '', currentUrl.toString());
      } else {
        throw new Error('Invalid response format');
      }
    })
    .catch(error => {
      console.error('Error fetching coaches:', error);
      coachListContainer.innerHTML = `
        <div class="col-span-full text-center p-6 sm:p-10 bg-red-50 text-red-700 rounded-lg border border-red-200">
          <p class="font-semibold text-sm sm:text-base">Oops! Gagal memuat data.</p>
          <p class="text-xs sm:text-sm mt-2">Silakan coba refresh halaman atau periksa koneksi Anda.</p>
        </div>
      `;
    })
    .finally(() => {
      coachListContainer.classList.remove('loading');
    });
  }

  // --- 2. FILTER FORM LISTENERS ---
  filterForm.querySelectorAll('input[name="q"]').forEach(input => {
    input.addEventListener('input', handleFilterChange);
  });
  
  filterForm.querySelectorAll('select').forEach(select => {
    select.addEventListener('change', handleFilterChange);
  });

  let filterTimeout;
  function handleFilterChange(e) {
    const formData = new FormData(filterForm);
    formData.delete('page');
   
    const params = new URLSearchParams();
    formData.forEach((value, key) => {
      if (value) params.append(key, value);
    });

    const url = `${filterUrl}?${params.toString()}`;
   
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      fetchCoaches(url);
    }, 350);
  }

  // --- 3. PAGINATION & MODAL HANDLERS (Event Delegation) ---
  coachListContainer.addEventListener('click', function(e) {
   
    // Pagination Handler
    const paginationButton = e.target.closest('.pagination-btn');
    if (paginationButton && !paginationButton.disabled) {
      e.preventDefault();
      const page = paginationButton.dataset.page;
     
      const formData = new FormData(filterForm);
      formData.set('page', page);
     
      const params = new URLSearchParams();
      formData.forEach((value, key) => {
        if (value) params.append(key, value);
      });

      const url = `${filterUrl}?${params.toString()}`;
      fetchCoaches(url);
      
      // Smooth scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
   
    // Detail Modal Handler
    const detailButton = e.target.closest('.open-detail-modal-btn');
    if (detailButton) {
      e.preventDefault();
      const detailUrl = detailButton.dataset.ajaxUrl;
      if (detailUrl) openDetailModal(detailUrl);
    }
  });

  // --- 4. MODAL FUNCTIONS ---
  function openDetailModal(url) {
    if (!modal || !modalContent || !modalBody || !modalSpinner) return;

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    modalBody.innerHTML = '';
    modalBody.appendChild(modalSpinner);
    modalSpinner.classList.remove('hidden');
    modalContent.style.opacity = '0';
    modalContent.style.transform = 'translateY(30px)';

    requestAnimationFrame(() => {
      modalContent.style.opacity = '1';
      modalContent.style.transform = 'translateY(0)';
    });

    fetch(url, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        if (data.html !== undefined) {
          modalBody.innerHTML = data.html;
        } else {
          throw new Error('Invalid detail response format');
        }
      })
      .catch(error => {
        console.error('Error fetching detail:', error);
        modalBody.innerHTML = `
          <div class="p-6 sm:p-10 text-center text-red-600">
            <p class="font-semibold text-sm sm:text-base">Gagal memuat detail.</p>
            <p class="text-xs sm:text-sm mt-2">Silakan coba lagi nanti.</p>
          </div>
        `;
      });
  }

  function hideDetailModal() {
    if (!modal || !modalContent) return;

    modalContent.style.opacity = '0';
    modalContent.style.transform = 'translateY(30px)';
    
    setTimeout(() => {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      modalBody.innerHTML = '';
      modalContent.style.opacity = '';
      modalContent.style.transform = '';
    }, 300);
  }

  // Close modal button
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', hideDetailModal);
  }
 
  // Click backdrop to close
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) hideDetailModal();
    });
  }

  // ESC key to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      hideDetailModal();
    }
  });
  
  // Prevent iOS background scroll when modal is open
  if (modal) {
    let touchStartY = 0;
    
    modal.addEventListener('touchstart', function(e) {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    modal.addEventListener('touchmove', function(e) {
      const modalContentEl = modalContent;
      const target = e.target;
      
      // Only prevent if touching the backdrop directly
      if (target === modal) {
        e.preventDefault();
      }
    }, { passive: false });
  }
});
</script>
{% endblock extra_js %}