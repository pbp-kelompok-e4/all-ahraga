{% extends "base_dashboard.html" %}

{% block title %}Daftar Pelatih{% endblock title %}

{% block page_title %}
  Daftar Pelatih
{% endblock page_title %}

{% block extra_head %}
<style>
  /* Hanya untuk memastikan JS classes seperti 'loading' dan 'hidden' bekerja, 
     dan untuk kustomisasi yang tidak mudah di Tailwind */
  
  /* Class for loading state from JS */
  #coach-list-container.loading {
    opacity: 0.5;
    transition: opacity 0.3s;
  }
  
  /* Modal Animation Helpers (Tailwind doesn't handle dynamic display:flex) */
  .modal:not(.hidden) {
    display: flex; /* Tailwind uses 'hidden', JS removes it */
    animation: fadeIn 0.3s ease forwards; /* Add fade-in animation */
  }
  .modal-content {
      /* Initial state for slide-up animation */
      opacity: 0;
      transform: translateY(30px);
      animation: slideUp 0.3s ease forwards;
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Responsive Design - Handled mostly by Tailwind */
  @media (max-width: 768px) {
    /* If specific non-Tailwind overrides are needed for mobile */
  }
</style>
{% endblock extra_head %}


{% block content %}
{# Container luar (coach-list-container, max-w-7xl, etc.) dihapus #}
{# Header Halaman (page-header) dihapus karena sudah ada di page_title #}

<div class="filter-box bg-white p-6 rounded-xl mb-8 shadow-lg border border-gray-100">
  <form id="filter-form" class="filter-form w-full">
    <div class="filter-controls grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-center"> {# Menggunakan grid untuk layout filter #}
      
      <input type="text" name="q" placeholder="Cari nama pelatih..."
             value="{{ request.GET.q }}" 
             class="search-input w-full p-3 border border-gray-300 rounded-lg text-sm transition-all duration-300 focus:outline-none focus:border-teal-600 focus:ring-2 focus:ring-teal-100 bg-gray-50 focus:bg-white">
     
      <select name="sport" class="filter-select w-full p-3 border border-gray-300 rounded-lg text-sm transition-all duration-300 focus:outline-none focus:border-teal-600 focus:ring-2 focus:ring-teal-100 bg-gray-50 focus:bg-white">
        <option value="">-- Semua Olahraga --</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if request.GET.sport == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>

      <select name="area" class="filter-select w-full p-3 border border-gray-300 rounded-lg text-sm transition-all duration-300 focus:outline-none focus:border-teal-600 focus:ring-2 focus:ring-teal-100 bg-gray-50 focus:bg-white">
        <option value="">-- Semua Area --</option>
        {% for area in areas %}
          <option value="{{ area.id }}" {% if request.GET.area == area.id|stringformat:"s" %}selected{% endif %}>
            {{ area.name }}
          </option>
        {% endfor %}
      </select>
     
      <a href="{% url 'coach_list' %}" class="reset-button w-full sm:w-auto text-center px-5 py-3 bg-gray-500 text-white rounded-lg text-sm font-semibold transition-all duration-300 hover:bg-gray-600">
        Reset Filter
      </a>
    </div>
  </form>
</div>

<div id="coach-list-container">
  {% include "main/coach_list_partial.html" %} {# Memuat konten awal #}
</div>

<div id="detailModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 z-[9998] items-center justify-center p-4 overflow-y-auto backdrop-blur-sm">
  <div id="detailModalContent" class="modal-content bg-white rounded-2xl max-w-xl w-full shadow-2xl relative max-h-[90vh] flex flex-col opacity-0 transform -translate-y-8 transition-all duration-300 ease-out"> {# Class awal untuk animasi #}
    <button id="closeDetailModal" class="close-modal-btn absolute top-3 right-3 z-10 p-2 rounded-full text-gray-500 bg-gray-100 hover:bg-gray-200 hover:text-gray-700 transition-colors"> {# Tombol close lebih subtle #}
      <i class="fa-solid fa-xmark text-xl"></i>
    </button>
   
    <div id="modal-body" class="modal-body overflow-y-auto flex-1">
      <div id="modal-spinner" class="modal-spinner p-10 text-center text-gray-600 flex flex-col items-center justify-center min-h-[200px]"> {# Min height agar spinner terlihat #}
        <div class="text-4xl mb-4 animate-spin text-teal-600"><i class="fa-solid fa-spinner"></i></div>
        Memuat detail pelatih...
      </div>
    </div>
  </div>
</div>
{% endblock content %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterForm = document.getElementById('filter-form');
  const coachListContainer = document.getElementById('coach-list-container');
  const modal = document.getElementById('detailModal');
  const modalContent = document.getElementById('detailModalContent'); 
  const modalBody = document.getElementById('modal-body');
  const modalSpinner = document.getElementById('modal-spinner'); // Spinner tetap ada
  const closeModalBtn = document.getElementById('closeDetailModal');
 
  const filterUrl = "{% url 'filter_coaches_ajax' %}";

  // --- 1. FUNGSI UNTUK FETCH FILTER/PAGINATION ---
  function fetchCoaches(url) {
    coachListContainer.classList.add('loading'); // Tampilkan state loading
   
    fetch(url, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest' // Header penting untuk request AJAX
      }
    })
    .then(response => {
        if (!response.ok) { throw new Error('Network response was not ok'); }
        return response.json(); // Ambil data JSON
     })
    .then(data => {
      if (data.html !== undefined) { // Cek jika ada HTML di response
          coachListContainer.innerHTML = data.html; // Ganti konten
         
          // Update URL browser (optional, tapi bagus untuk UX)
          const currentUrl = new URL(window.location);
          const newParams = new URLSearchParams(url.split('?')[1] || ''); // Ambil params dari URL fetch
          
          // Hapus parameter filter kosong dari URL browser
          newParams.forEach((value, key) => {
              if (!value) newParams.delete(key);
          });

          currentUrl.search = newParams.toString(); // Update query string
          window.history.pushState({ path: currentUrl.toString() }, '', currentUrl.toString());
      } else {
           throw new Error('Invalid response format');
      }
    })
    .catch(error => {
      console.error('Error fetching coaches:', error);
      // Tampilkan pesan error yang lebih user-friendly
      coachListContainer.innerHTML = `<div class="col-span-full text-center p-10 bg-red-50 text-red-700 rounded-lg border border-red-200"><p class="font-semibold">Oops! Gagal memuat data.</p><p class="text-sm">Silakan coba refresh halaman atau periksa koneksi Anda.</p></div>`;
    })
    .finally(() => {
      coachListContainer.classList.remove('loading'); // Hapus state loading
    });
  }

  // --- 2. EVENT LISTENER UNTUK FILTER FORM ---
  // Gunakan event 'input' untuk search, 'change' untuk select
  filterForm.querySelectorAll('input[name="q"]').forEach(input => {
      input.addEventListener('input', handleFilterChange);
  });
  filterForm.querySelectorAll('select').forEach(select => {
       select.addEventListener('change', handleFilterChange);
  });

  let filterTimeout;
  function handleFilterChange(e) {
    // Selalu hapus parameter 'page' saat filter diubah
    const formData = new FormData(filterForm);
    formData.delete('page'); 
   
    // Buat URLSearchParams dari FormData
    const params = new URLSearchParams();
    formData.forEach((value, key) => {
        if (value) { // Hanya tambahkan parameter jika ada nilainya
            params.append(key, value);
        }
    });

    const url = `${filterUrl}?${params.toString()}`;
   
    // Debounce: Tunda fetch sedikit
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      fetchCoaches(url);
    }, 350); // Tunda 350ms
  }

  // --- 3. EVENT LISTENER UNTUK PAGINATION & MODAL (Event Delegation) ---
  // Pasang listener di container utama
  coachListContainer.addEventListener('click', function(e) {
   
    // --- Handler untuk PAGINATION ---
    const paginationButton = e.target.closest('.pagination-btn');
    if (paginationButton && !paginationButton.disabled) { // Cek jika tombol pagination diklik & tidak disabled
      e.preventDefault();
      const page = paginationButton.dataset.page;
     
      // Ambil filter yang sedang aktif
      const formData = new FormData(filterForm);
      // SET halaman yang dituju
      formData.set('page', page); 
     
      const params = new URLSearchParams();
       formData.forEach((value, key) => {
           if (value) params.append(key, value);
       });

      const url = `${filterUrl}?${params.toString()}`;
      fetchCoaches(url);
    }
   
    // --- Handler untuk DETAIL MODAL ---
    const detailButton = e.target.closest('.open-detail-modal-btn');
    if (detailButton) {
      e.preventDefault();
      const detailUrl = detailButton.dataset.ajaxUrl;
      if (detailUrl) { // Pastikan URL ada
          openDetailModal(detailUrl);
      }
    }
  });

  // --- 4. FUNGSI UNTUK MODAL ---
  function openDetailModal(url) {
    if (!modal || !modalContent || !modalBody || !modalSpinner) return;

    modal.classList.remove('hidden'); // Tampilkan modal (termasuk backdrop)
    document.body.style.overflow = 'hidden'; // Stop scroll background
    
    // Reset konten modal ke spinner & atur state animasi awal
    modalBody.innerHTML = ''; 
    modalBody.appendChild(modalSpinner); // Tampilkan spinner lagi
    modalSpinner.classList.remove('hidden'); // Pastikan spinner terlihat
    modalContent.style.opacity = '0'; // Mulai transparan
    modalContent.style.transform = 'translateY(30px)'; // Mulai sedikit ke bawah

    // Mulai animasi masuk setelah sedikit delay
    requestAnimationFrame(() => {
        modalContent.style.opacity = '1';
        modalContent.style.transform = 'translateY(0)';
    });

    // Fetch detail coach
    fetch(url, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
      .then(response => {
           if (!response.ok) { throw new Error('Network response was not ok'); }
           return response.json();
        })
      .then(data => {
        if (data.html !== undefined) {
             modalBody.innerHTML = data.html; // Ganti spinner dengan konten detail
         } else {
             throw new Error('Invalid detail response format');
         }
      })
      .catch(error => {
        console.error('Error fetching detail:', error);
        modalBody.innerHTML = `<div class="p-10 text-center text-red-600"><p class="font-semibold">Gagal memuat detail.</p><p class="text-sm">Silakan coba lagi nanti.</p></div>`;
      });
  }

  function hideDetailModal() {
    if (!modal || !modalContent) return;

    // Mulai animasi keluar
    modalContent.style.opacity = '0';
    modalContent.style.transform = 'translateY(30px)';
    
    // Sembunyikan modal setelah animasi selesai
    setTimeout(() => {
        modal.classList.add('hidden'); 
        document.body.style.overflow = 'auto'; // Kembalikan scroll background
        modalBody.innerHTML = ''; // Kosongkan konten untuk load berikutnya
        // Reset style animasi (jika diperlukan untuk animasi masuk berikutnya)
        modalContent.style.opacity = ''; 
        modalContent.style.transform = '';
    }, 300); // Durasi HARUS sama dengan transisi CSS/Style
  }

  // Event listener tombol close
  if(closeModalBtn) closeModalBtn.addEventListener('click', hideDetailModal);
 
  // Event listener klik backdrop
  if(modal) {
    modal.addEventListener('click', function(e) {
      // Hanya tutup jika klik pada backdrop (modal), bukan konten di dalamnya
      if (e.target === modal) {
        hideDetailModal();
      }
    });
  }

  // Event listener tombol Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) { // Cek jika modal sedang terbuka
      hideDetailModal();
    }
  });
});
</script>
{% endblock extra_js %}