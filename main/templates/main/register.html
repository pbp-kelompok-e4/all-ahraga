{% extends "base.html" %}
{% load static %}

{% block title %}Sign Up | All-Ahraga{% endblock title %}

{% block extra_head %}
<style>
  @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform:none;} }
  @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
  
  .animate-fade-in { animation: fadeIn .6s ease-out forwards; }

  body {
    background: linear-gradient(135deg, #0f766e 0%, #0d9488 50%, #14b8a6 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  /* Dekorasi lingkaran floating */
  body::before {
    content: '';
    position: fixed;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(20,184,166,.15) 0%, transparent 70%);
    border-radius: 50%;
    top: -100px;
    right: -100px;
    z-index: 0;
    animation: float 6s ease-in-out infinite;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(13,148,136,.1) 0%, transparent 70%);
    border-radius: 50%;
    bottom: -50px;
    left: -50px;
    z-index: 0;
    animation: float 8s ease-in-out infinite reverse;
    pointer-events: none;
  }

  header, nav, footer { position: relative; z-index: 5; }

  .page-center {
    position: relative;
    z-index: 2;
    min-height: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2.5rem 1rem;
  }

  .login-hero-title {
    color: #fff;
    text-align: center;
    font-weight: 900;
    font-size: clamp(2rem, 2.4vw + 1.2rem, 2.8rem);
    letter-spacing: -0.02em;
    line-height: 1.1;
    text-shadow: 0 10px 28px rgba(0,0,0,.25);
    margin-bottom: .6rem;
  }

  .login-hero-sub {
    color: rgba(255,255,255,.95);
    text-align: center;
    margin-bottom: 1.5rem;
    font-size: clamp(.95rem, .5vw + .75rem, 1.1rem);
  }

  .register-card {
    background: #fff;
    border-radius: 1.25rem;
    padding: 2rem;
    max-width: 460px;
    width: 100%;
    box-shadow: 0 18px 40px rgba(0,0,0,.25);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,.2);
  }

  .form-label{ font-size:.9rem; font-weight:700; color:#334155; margin-bottom:.4rem; display:block; }
  .styled-input{
    width:100%; background:#f8fafc; border:1.5px solid #cbd5e1; border-radius:.85rem;
    padding:.8rem 1rem; font-size:.95rem; transition:.18s;
  }
  .styled-input:focus{ outline:none; border-color:#0d9488; box-shadow:0 0 0 3px rgba(13,148,136,.15); background:#fff; }

  .btn-register{
    width:100%; border:none; border-radius:.9rem; padding:.9rem 1rem;
    background:linear-gradient(90deg,#0f766e,#0d9488);
    color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(13,148,136,.35);
    transition:.15s ease;
  }
  .btn-register:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(13,148,136,.45); }

  .register-meta{text-align:center;margin-top:1rem;color:#334155;font-size:.92rem;}
  .register-meta a{color:#0d9488;font-weight:800;}
  .register-meta a:hover{text-decoration:underline;}

  .error-box{
    display:none;margin-bottom:.9rem;background:linear-gradient(135deg,#fee2e2,#fecaca);
    border:2px solid #ef4444;color:#7f1d1d;border-radius:1rem;padding:1rem 1.2rem;
    font-size:.92rem;font-weight:600;box-shadow:0 8px 16px rgba(239,68,68,.15);
  }

  @keyframes slideInUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
  @keyframes slideOutDown { from { opacity:1; transform:translateY(0); } to { opacity:0; transform:translateY(30px); } }

  #toast{
    position:fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index:60;
    max-width:380px;
    padding:1rem 1.5rem;
    border-radius:1rem;
    font-weight:700;
    font-size:.95rem;
    display:flex;
    align-items:center;
    gap:0.75rem;
    box-shadow:0 16px 32px rgba(0,0,0,.3);
    opacity:0;
    transform:translateY(30px);
    transition:opacity .3s ease, transform .3s ease;
    pointer-events:none;
  }

  #toast.show{
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
    animation:slideInUp .4s cubic-bezier(0.16,1,0.3,1);
  }

  #toast.hide{
    animation:slideOutDown .3s ease forwards;
  }

  #toast::before{
    content:'✓';
    font-size:1.3rem;
    font-weight:900;
    flex-shrink:0;
  }

  #toast.error::before{
    content:'⚠';
    color:#ef4444;
  }

  #toast.success::before{
    color:#22c55e;
  }
</style>
{% endblock extra_head %}

{% block content %}
<div class="page-center">
  <h1 class="login-hero-title animate-fade-in">Buat Akun Baru</h1>
  <p class="login-hero-sub animate-fade-in" style="animation-delay:.08s">Daftar untuk mulai booking venue & coach favoritmu</p>

  <div id="toast" role="status" aria-live="polite"></div>

  <div class="register-card animate-fade-in" style="animation-delay:.12s">
    <div id="register-errors" class="error-box"></div>

    <form method="post" class="space-y-5" id="register-form" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="err text-left">{{ form.non_field_errors }}</div>
      {% endif %}

      <div>
        <label for="id_username" class="form-label">Username</label>
        {{ form.username }}
        {% for e in form.username.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_email" class="form-label">Email</label>
        {{ form.email }}
        {% for e in form.email.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_phone_number" class="form-label">Nomor HP</label>
        {{ form.phone_number }}
        {% for e in form.phone_number.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_role_type" class="form-label">Daftar sebagai</label>
        {{ form.role_type }}
        {% for e in form.role_type.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_password1" class="form-label">Password</label>
        {{ form.password1 }}
        {% for e in form.password1.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_password2" class="form-label">Konfirmasi Password</label>
        {{ form.password2 }}
        {% for e in form.password2.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <button type="submit" class="btn-register">Daftar</button>
    </form>

    <div class="register-meta">
      Sudah punya akun? <a href="{% url 'login' %}">Masuk</a>
    </div>
  </div>
</div>

<script>
  (function(){
    const set = (id, ph) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('styled-input');
      if (ph) el.placeholder = ph;
      if (el.tagName !== 'SELECT' && el.type !== 'password') el.autocomplete = 'off';
    };
    set('id_username', 'Masukkan username');
    set('id_email', 'Masukkan email');
    set('id_phone_number', 'Masukkan nomor HP');
    set('id_role_type');
    set('id_password1', 'Masukkan password');
    set('id_password2', 'Ulangi password');
  })();

  function showToast(message, type='success', duration=3500){
    const t = document.getElementById('toast');
    if(!t) return;
    
    t.textContent = message;
    t.className = 'show ' + type;
    
    if (type === 'error') {
      t.style.background = 'linear-gradient(135deg,#fee2e2,#fecaca)';
      t.style.color = '#7f1d1d';
      t.style.boxShadow = '0 16px 32px rgba(239,68,68,.25)';
    } else {
      t.style.background = 'linear-gradient(135deg,#dcfce7,#bbf7d0)';
      t.style.color = '#166534';
      t.style.boxShadow = '0 16px 32px rgba(34,197,94,.25)';
    }
    
    clearTimeout(t._timeout);
    t._timeout = setTimeout(()=>{
      t.classList.remove('show');
      t.classList.add('hide');
      setTimeout(()=>{ t.classList.remove('hide'); }, 300);
    }, duration);
  }

  (function(){
    const img = document.querySelector('.bg-img');
    if (!img) return;
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const DIR = -1; 
    const PARALLAX_FACTOR = 0.25;
    const SCALE = 1.08;

    img.style.willChange = 'transform';
    img.style.backfaceVisibility = 'hidden';
    img.style.transform = `translate3d(0,0,0) scale(${SCALE})`;

    let raf = null, lastY = window.scrollY || 0;
    function update(){
      raf = null;
      const y = Math.max(0, Math.min(lastY, 3000)) * PARALLAX_FACTOR * DIR;
      img.style.transform = `translate3d(0, ${y}px, 0) scale(${SCALE})`;
    }
    function onScroll(){
      lastY = window.scrollY || 0;
      if (!raf) raf = requestAnimationFrame(update);
    }
    update();
    window.addEventListener('scroll', onScroll, { passive: true });
  })();

  (function(){
    const form = document.getElementById('register-form');
    const errorBox = document.getElementById('register-errors');
    if (!form) return;

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const fd = new FormData(form);
      try {
        const resp = await fetch("", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": fd.get("csrfmiddlewaretoken"),
          },
          body: fd
        });
        const data = await resp.json().catch(()=> ({}));

        if (resp.ok && data.ok) {
          localStorage.setItem('toastData', JSON.stringify({
            message: "Registrasi berhasil! Silakan login..",
            type: 'success',
            duration: 3500,
            trigger: 'after_register_success',
            ts: Date.now()
          }));
          showToast("✓ Registrasi berhasil! Silakan login..","success",3500);
          setTimeout(()=>{ window.location.href = data.redirect || "{% url 'login' %}"; }, 800);
          return;
        }
        
        let errorMessages = [];
        if (data?.errors) {
          Object.entries(data.errors).forEach(([field, msgs])=>{
            const fieldLabel = field.replace(/_/g,' ').toUpperCase();
            if (Array.isArray(msgs)) {
              errorMessages.push(`${fieldLabel}: ${msgs.join(', ')}`);
            } else {
              errorMessages.push(`${fieldLabel}: ${msgs}`);
            }
          });
        }
        
        if (errorMessages.length === 0) {
          errorMessages = ["Registrasi gagal. Periksa kembali data Anda."];
        }
        
        errorBox.style.display = 'block';
        errorBox.innerHTML = errorMessages.map(msg => `<div style="margin-bottom:0.5rem;">• ${msg}</div>`).join('');
        errorBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        showToast("❌ " + errorMessages[0].split(':')[0] + " tidak valid", "error", 4000);
      } catch (err) {
        errorBox.style.display = 'block';
        errorBox.innerHTML = '<div style="font-weight:700;">Kesalahan jaringan</div><div style="margin-top:0.3rem;">Pastikan koneksi internet Anda stabil dan coba lagi.</div>';
        errorBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        showToast("❌ Kesalahan jaringan. Coba lagi.", "error", 4000);
      }
    });
  })();
</script>
{% endblock content %}
