{% extends "base.html" %}
{% load static %}

{% block title %}Sign Up{% endblock title %}

{% block extra_head %}
<style>
  body {
    background-image: url("{% static 'image/bg-court.jpg' %}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  .page-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 95vh;
    gap: 1.5rem;
    position: relative;
    z-index: 2;
    padding: 2rem;
  }

  .bg-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 1;
    pointer-events: none;
  }

  .register-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 1.5rem;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .btn-register {
    background-color: #4c8c78;
  }
  .btn-register:hover {
    background-color: #3c7b69;
  }

  input, select {
    background-color: rgba(243, 244, 246, 0.9);
    border-radius: 6px;
    border: 1px solid #d1d5db;
    width: 100%;
    padding: 10px;
  }

  #coach-fields {
    display: none;
    margin-top: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.7);
  }
  #coach-fields.show-coach { display: block; }

  h1.title-main {
    font-size: 2.5rem;
    font-weight: 700;
    text-align: center;
    color: white;
    text-shadow: 0 3px 6px rgba(0,0,0,0.3);
  }

  h3.form-title {
    font-weight: 600;
    text-align: center;
    color: #374151;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  /* Venue item styling (checkbox + text sejajar rapi) */
  .venue-item {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    border-bottom: 1px solid #e5e7eb;
    padding: 0.5rem 0;
    gap: 1rem;
  }

  .venue-item .left {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .venue-item input[type="checkbox"] {
    margin-top: 3px;
    flex-shrink: 0;
  }

  .venue-item label {
    font-weight: 500;
    cursor: pointer;
  }

  .venue-item .text-gray-600 {
    font-size: 0.75rem;
  }

  .venue-rate-input {
    width: 110px;
  }
</style>
{% endblock extra_head %}

{% block content %}
<div class="bg-overlay"></div>

<div class="page-center">
  <h1 class="title-main">Create Your Account</h1>

  <div class="register-card w-full max-w-lg px-10 py-8 text-center">
    <h3 class="form-title">SIGN UP</h3>
    <hr class="border-gray-300 mb-6">

    <form method="post" enctype="multipart/form-data" id="register-form" class="space-y-4 text-left">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div>
        <label class="block text-sm font-medium text-gray-700">Username</label>
        {{ form.username }}
        <small class="text-gray-500 text-xs">Enter your username</small>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        {{ form.email }}
        <small class="text-gray-500 text-xs">Enter your email address</small>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Phone Number</label>
        {{ form.phone_number }}
        <small class="text-gray-500 text-xs">Enter your phone number</small>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Sign Up As</label>
        {{ form.role_type }}
      </div>

      <!-- COACH FIELDS -->
      <div id="coach-fields" class="{% if show_coach_fields %}show-coach{% endif %}">
        <label class="block text-sm font-semibold text-gray-800 mb-2">Service Area (Coach)</label>
        {{ form.service_area }}

        <div class="mt-3">
          <input type="search" id="venue-search" placeholder="Search venues by name or area"
                 class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
        </div>

        <div class="mt-3">
          <label class="text-sm font-medium text-gray-700 mb-1">Choose Venues to Teach At:</label>
          <div id="venue-list" class="max-h-60 overflow-auto border border-gray-300 rounded-md p-3 bg-white/60 text-sm">
            {% for v in venues %}
              <div class="venue-item"
                   data-venue-id="{{ v.id }}" data-venue-name="{{ v.name|lower }}" data-venue-location="{{ v.location.id }}">
                <div class="left">
                  <input type="checkbox" class="venue-check" data-venue-id="{{ v.id }}" id="venue-{{ v.id }}">
                  <div>
                    <label for="venue-{{ v.id }}">{{ v.name }}</label>
                    <div class="text-gray-600">{{ v.location }}</div>
                    <div class="text-teal-600 text-xs"><a href="{% url 'venue_detail' v.id %}">View details</a></div>
                  </div>
                </div>
                <input type="number" min="0" class="venue-rate-input border border-gray-300 rounded-md px-2 py-1 text-sm hidden"
                       data-venue-id="{{ v.id }}" placeholder="Your rate (Rp)">
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="mt-3">
          <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
          {{ form.profile_picture }}
        </div>

        {{ form.selected_venues_json }}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div>
          <label class="block text-sm font-medium text-gray-700">Password</label>
          {{ form.password1 }}
          <small class="text-gray-500 text-xs">Enter a strong password</small>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
          {{ form.password2 }}
          <small class="text-gray-500 text-xs">Re-enter your password</small>
        </div>
      </div>

      <button type="submit" id="register-submit"
        class="btn-register w-full py-2 mt-3 text-white rounded-full font-medium transition shadow">
        Sign Up
      </button>
    </form>

    <p class="text-sm text-gray-700 mt-6 text-center">
      Already have an account?
      <a href="{% url 'login' %}" class="text-teal-600 hover:underline font-medium">Log in here</a>
    </p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const roleField = document.getElementById('id_role_type');
    const coachFields = document.getElementById('coach-fields');
    const registerForm = document.getElementById('register-form');
    const selectedInput = document.getElementById('id_selected_venues_json');
    const venueSearch = document.getElementById('venue-search');
    const serviceAreaSelect = document.getElementById('id_service_area');

    function venueChecksList(){
        return Array.from(document.querySelectorAll('.venue-check'));
    }

    function toggleCoachFields(){
        if(roleField && roleField.value === 'COACH'){
            coachFields.classList.add('show-coach');
        } else {
            coachFields.classList.remove('show-coach');
        }
    }
    if(roleField){
        roleField.addEventListener('change', toggleCoachFields);
        toggleCoachFields();
    }

    function attachCheckboxHandlers(){
        venueChecksList().forEach(chk => {
            chk.addEventListener('change', function(){
                const vid = this.dataset.venueId;
                const rateEl = document.querySelector('.venue-rate-input[data-venue-id="'+vid+'"]');
                if(rateEl){
                    if(this.checked){
                        rateEl.classList.remove('hidden');
                        rateEl.required = true;
                    } else {
                        rateEl.classList.add('hidden');
                        rateEl.required = false;
                        rateEl.value = '';
                    }
                }
            });
        });
    }
    attachCheckboxHandlers();

    function filterVenues(){
        const term = venueSearch.value.trim().toLowerCase();
        const areaId = serviceAreaSelect ? serviceAreaSelect.value : '';
        document.querySelectorAll('.venue-item').forEach(it=>{
            const name = it.dataset.venueName || '';
            const loc = String(it.dataset.venueLocation || '');
            const matchesTerm = !term || name.includes(term);
            const matchesArea = !areaId || areaId === loc;
            it.style.display = (matchesTerm && matchesArea) ? 'flex' : 'none';
            if(!matchesTerm || !matchesArea){
                const chk = it.querySelector('.venue-check');
                const rateEl = it.querySelector('.venue-rate-input');
                if(chk){ chk.checked = false; }
                if(rateEl){ rateEl.classList.add('hidden'); rateEl.required = false; rateEl.value = ''; }
            }
        });
    }

    if(venueSearch){ venueSearch.addEventListener('input', filterVenues); }
    if(serviceAreaSelect){ serviceAreaSelect.addEventListener('change', filterVenues); }

    registerForm.addEventListener('submit', function(){
        const selected = [];
        venueChecksList().forEach(chk=>{
            if(chk.checked){
                const vid = chk.dataset.venueId;
                const rateEl = document.querySelector('.venue-rate-input[data-venue-id="'+vid+'"]');
                selected.push({venue_id: vid, rate: rateEl ? rateEl.value : 0});
            } 
        });
        if(selectedInput){ selectedInput.value = JSON.stringify(selected); }
    });
});
</script>
{% endblock content %}
