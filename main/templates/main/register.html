{% extends "base.html" %}
{% load static %}

{% block title %}Sign Up | All-Ahraga{% endblock title %}

{% block extra_head %}
<style>
  @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform:none;} }
  .animate-fade-in { animation: fadeIn .6s ease-out forwards; }

  .bg-img{
    position: fixed; inset: 0; background:url("{% static 'image/bg-court.jpg' %}") center/cover no-repeat;
    filter: blur(6px) saturate(1.05);
    z-index:0;
  }
  .bg-tint{
    position: fixed; inset: 0;
    background: linear-gradient(135deg, rgba(13,148,136,.55), rgba(17,94,89,.65)), rgba(0,0,0,.35);
    mix-blend-mode: multiply; z-index:1;
  }
  header, nav, footer { position: relative; z-index: 5; }

  .page-center{
    position:relative; z-index:2; min-height:80vh;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:3rem 1rem 4rem;
  }

  .login-hero-title{
    color:#fff; text-align:center; font-weight:900;
    font-size:clamp(2.2rem, 2.6vw + 1.4rem, 3.1rem);
    letter-spacing:-0.02em; line-height:1.1;
    text-shadow:0 10px 28px rgba(0,0,0,.35);
    margin-bottom:.8rem;
  }
  .login-hero-sub{
    color:rgba(255,255,255,.92); text-align:center; margin-bottom:1.8rem;
    font-size:clamp(1rem, .6vw + .8rem, 1.2rem);
  }

  .register-card{
    background:#fff; border-radius:1.25rem; padding:2rem; max-width:460px; width:100%;
    box-shadow:0 18px 40px rgba(0,0,0,.18);
  }

  .form-label{ font-size:.9rem; font-weight:700; color:#334155; margin-bottom:.4rem; display:block; }
  .styled-input{
    width:100%; background:#f8fafc; border:1.5px solid #cbd5e1; border-radius:.85rem;
    padding:.8rem 1rem; font-size:.95rem; transition:.18s;
  }
  .styled-input:focus{ outline:none; border-color:#0d9488; box-shadow:0 0 0 3px rgba(13,148,136,.15); background:#fff; }

  .btn-register{
    width:100%; border:none; border-radius:.9rem; padding:.9rem 1rem;
    background:linear-gradient(90deg,#0f766e,#0d9488);
    color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(13,148,136,.35);
    transition:.15s ease;
  }
  .btn-register:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(13,148,136,.45); }

  .register-meta{text-align:center;margin-top:1rem;color:#334155;font-size:.92rem;}
  .register-meta a{color:#0d9488;font-weight:800;}
  .register-meta a:hover{text-decoration:underline;}

  .error-box{
    display:none;margin-bottom:.9rem;background:#fee2e2;border:1px solid #fca5a5;
    color:#7f1d1d;border-radius:.85rem;padding:.7rem .9rem;font-size:.9rem;
  }

  #toast{
    position:fixed;
    bottom: 1.25rem; /* <-- Diubah dari 'top' */
    right: 1.25rem;
    z-index:60;
    /* ... */
    opacity:0; transform:translateY(10px); /* <-- Animasi dari bawah */
    transition:opacity .25s ease, transform .25s ease;
    font-weight:600;
  }
  #toast.show{ opacity:1; transform:translateY(0); }
</style>
{% endblock extra_head %}

{% block content %}
<div class="bg-img"></div>
<div class="bg-tint"></div>

<div class="page-center">
  <h1 class="login-hero-title animate-fade-in">Buat Akun Baru</h1>
  <p class="login-hero-sub animate-fade-in" style="animation-delay:.08s">Daftar untuk mulai booking venue & coach favoritmu</p>

  <div id="toast" role="status" aria-live="polite"></div>

  <div class="register-card animate-fade-in" style="animation-delay:.12s">
    <div id="register-errors" class="error-box"></div>

    <form method="post" class="space-y-5" id="register-form" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="err text-left">{{ form.non_field_errors }}</div>
      {% endif %}

      <div>
        <label for="id_username" class="form-label">Username</label>
        {{ form.username }}
        {% for e in form.username.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_email" class="form-label">Email</label>
        {{ form.email }}
        {% for e in form.email.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_phone_number" class="form-label">Nomor HP</label>
        {{ form.phone_number }}
        {% for e in form.phone_number.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_role_type" class="form-label">Daftar sebagai</label>
        {{ form.role_type }}
        {% for e in form.role_type.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_password1" class="form-label">Password</label>
        {{ form.password1 }}
        {% for e in form.password1.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div>
        <label for="id_password2" class="form-label">Konfirmasi Password</label>
        {{ form.password2 }}
        {% for e in form.password2.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <button type="submit" class="btn-register">Daftar</button>
    </form>

    <div class="register-meta">
      Sudah punya akun? <a href="{% url 'login' %}">Masuk</a>
    </div>
  </div>
</div>

<script>
  (function(){
    const set = (id, ph) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('styled-input');
      if (ph) el.placeholder = ph;
      if (el.tagName !== 'SELECT' && el.type !== 'password') el.autocomplete = 'off';
    };
    set('id_username', 'Masukkan username');
    set('id_email', 'Masukkan email');
    set('id_phone_number', 'Masukkan nomor HP');
    set('id_role_type');
    set('id_password1', 'Masukkan password');
    set('id_password2', 'Ulangi password');
  })();

  function showToast(message,type='success',duration=3000){
    const t=document.getElementById('toast');
    if(!t)return;
    t.textContent=message;
    t.style.background=(type==='error')
      ?'linear-gradient(90deg,#b91c1c,#dc2626)'
      :'linear-gradient(90deg,#059669,#0d9488)';
    t.classList.add('show');
    clearTimeout(t._timeout);
    t._timeout=setTimeout(()=>{t.classList.remove('show');},duration);
  }

  (function(){
    const img = document.querySelector('.bg-img');
    if (!img) return;
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const DIR = -1; 
    const PARALLAX_FACTOR = 0.25;
    const SCALE = 1.08;

    img.style.willChange = 'transform';
    img.style.backfaceVisibility = 'hidden';
    img.style.transform = `translate3d(0,0,0) scale(${SCALE})`;

    let raf = null, lastY = window.scrollY || 0;
    function update(){
      raf = null;
      const y = Math.max(0, Math.min(lastY, 3000)) * PARALLAX_FACTOR * DIR;
      img.style.transform = `translate3d(0, ${y}px, 0) scale(${SCALE})`;
    }
    function onScroll(){
      lastY = window.scrollY || 0;
      if (!raf) raf = requestAnimationFrame(update);
    }
    update();
    window.addEventListener('scroll', onScroll, { passive: true });
  })();

  // AJAX submit register 
  (function(){
    const form = document.getElementById('register-form');
    const errorBox = document.getElementById('register-errors');
    if (!form) return;

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const fd = new FormData(form);
      try {
        const resp = await fetch("", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": fd.get("csrfmiddlewaretoken"),
          },
          body: fd
        });
        const data = await resp.json().catch(()=> ({}));

        if (resp.ok && data.ok) {
          localStorage.setItem('toastData', JSON.stringify({
            message: "Registrasi berhasil! Silakan login..",
            type: 'success',
            duration: 3500,
            trigger: 'after_register_success',
            ts: Date.now()
          }));
          window.location.href = data.redirect || "{% url 'login' %}";
          return;
        }
        const messages = data?.errors ? Object.values(data.errors).flat() : ["Registrasi gagal."];
        errorBox.style.display = 'block';
        errorBox.innerHTML = messages.join('<br>');
        showToast("Registrasi gagal. Periksa kembali data Anda.","error",3200);
      } catch (err) {
        errorBox.style.display = 'block';
        errorBox.textContent = "Kesalahan jaringan. Silakan coba lagi.";
        showToast("Kesalahan jaringan.","error",3200);
      }
    });
  })();
</script>
{% endblock content %}
