{% extends "base.html" %}
{% load static %}

{% block title %}Log In{% endblock title %}

{% block extra_head %}
<style>
  /* === Background Layers === */
  .bg-img {
    position: fixed;
    inset: 0;
    background-image: url("{% static 'image/bg-court.jpg' %}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(8px);
    will-change: transform;
    z-index: 0;
  }
  .bg-tint {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    z-index: 1;
    pointer-events: none;
  }

  header, nav, footer { position: relative; z-index: 5; }

  /* === Layout Content === */
  .page-center {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 80vh; gap: 1rem; position: relative; z-index: 2; padding: 2rem;
  }

  /* === Login Card === */
  .login-card {
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(12px);
    border-radius: 1.5rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .btn-login { background-color: #90b4aa; }
  .btn-login:hover { background-color: #7ea59a; }

  .styled-input {
    width: 100%; padding: .6rem 1rem; border: 1px solid #d1d5db; border-radius: .5rem;
    background: rgba(229,231,235,.7); outline: none;
  }
  .styled-input:focus { box-shadow: 0 0 0 2px rgba(45,212,191,.35); }
  input::placeholder { color: #9ca3af; }

  .err { color: #b91c1c; font-size: .85rem; margin-top: .25rem; }
</style>
{% endblock extra_head %}

{% block content %}
<!-- Background layers -->
<div class="bg-img" data-parallax-direction="against" data-parallax-factor="0.25"></div>
<div class="bg-tint"></div>

<div class="page-center">
  <h1 class="text-4xl font-semibold text-white drop-shadow-md">Welcome!</h1>

  <div class="login-card w-full max-w-md px-10 py-8 border border-gray-200 text-center">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 tracking-wide">LOGIN</h3>
    <hr class="border-gray-300 mb-6">

    <!-- Placeholder error AJAX -->
    <div id="login-errors" class="text-red-600 text-sm text-left mb-2" style="display:none"></div>

    <form method="post" class="space-y-5" id="login-form">
      {% csrf_token %}

      <div>
        <label for="id_username" class="block text-sm font-medium text-gray-700 text-left mb-1">username</label>
        {{ form.username }}
      </div>

      <div>
        <label for="id_password" class="block text-sm font-medium text-gray-700 text-left mb-1">password</label>
        {{ form.password }}
      </div>

      <button type="submit" class="btn-login w-full py-2 text-white rounded-full font-medium transition shadow">
        Log in
      </button>
    </form>

    <p class="text-sm text-gray-700 mt-6">
      Donâ€™t have any account?
      <a href="{% url 'register' %}" class="text-teal-600 hover:underline font-medium">Sign up here</a>
    </p>
  </div>
</div>

<script>
  // Styling input
  (function(){
    const set = (id, ph) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('styled-input');
      if (ph) el.placeholder = ph;
      if (el.type !== 'password') el.autocomplete = 'off';
    };
    set('id_username', 'Enter your username');
    set('id_password', 'Enter your password');
  })();

  // Parallax background
  (function(){
    const img = document.querySelector('.bg-img');
    if (!img) return;
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const dirAttr = (img.getAttribute('data-parallax-direction') || 'with').toLowerCase();
    const DIR = dirAttr === 'against' ? -1 : 1;
    const factorAttr = parseFloat(img.getAttribute('data-parallax-factor'));
    const PARALLAX_FACTOR = isNaN(factorAttr) ? 0.25 : factorAttr;
    const SCALE = 1.08;

    img.style.willChange = 'transform';
    img.style.backfaceVisibility = 'hidden';
    img.style.transform = `translate3d(0,0,0) scale(${SCALE})`;

    let raf = null, lastY = window.scrollY || 0;
    function update(){
      raf = null;
      const y = Math.max(0, Math.min(lastY, 3000)) * PARALLAX_FACTOR * DIR;
      img.style.transform = `translate3d(0, ${y}px, 0) scale(${SCALE})`;
    }
    function onScroll(){
      lastY = window.scrollY || 0;
      if (!raf) raf = requestAnimationFrame(update);
    }
    update();
    window.addEventListener('scroll', onScroll, { passive: true });
  })();

  // AJAX submit login
  (function(){
    const form = document.getElementById('login-form');
    const errorBox = document.getElementById('login-errors');
    if (!form) return;

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const fd = new FormData(form);
      try {
        const resp = await fetch("", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": fd.get("csrfmiddlewaretoken"),
          },
          body: fd
        });
        const data = await resp.json();
        if (resp.ok && data.ok) {
          window.location.href = data.redirect || "{% url 'home' %}";
          return;
        }
        // Tampilkan error
        const messages = data.errors ? Object.values(data.errors).flat() : ["Login failed."];
        errorBox.style.display = 'block';
        errorBox.innerHTML = messages.join('<br>');
      } catch (err) {
        errorBox.style.display = 'block';
        errorBox.textContent = "Network error. Please try again.";
      }
    });
  })();
</script>
{% endblock content %}
