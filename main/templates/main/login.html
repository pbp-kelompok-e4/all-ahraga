{% extends "base.html" %}
{% load static %}

{% block title %}Login | All-Ahraga{% endblock title %}

{% block extra_head %}
<style>
  @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform:none;} }
  @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
  @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(13,148,136,.3); } 50% { box-shadow: 0 0 40px rgba(13,148,136,.6); } }
  
  .animate-fade-in { animation: fadeIn .6s ease-out forwards; }

  body {
    background: linear-gradient(135deg, #0f766e 0%, #0d9488 50%, #14b8a6 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  /* Dekorasi lingkaran floating */
  body::before {
    content: '';
    position: fixed;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(20,184,166,.15) 0%, transparent 70%);
    border-radius: 50%;
    top: -100px;
    right: -100px;
    z-index: 0;
    animation: float 6s ease-in-out infinite;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(13,148,136,.1) 0%, transparent 70%);
    border-radius: 50%;
    bottom: -50px;
    left: -50px;
    z-index: 0;
    animation: float 8s ease-in-out infinite reverse;
    pointer-events: none;
  }

  header, nav, footer { position: relative; z-index: 5; }

  .page-center {
    position: relative;
    z-index: 2;
    min-height: 80vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem 4rem;
  }

  .login-hero-title {
    color: #fff;
    text-align: center;
    font-weight: 900;
    font-size: clamp(2.2rem, 2.6vw + 1.4rem, 3.1rem);
    letter-spacing: -0.02em;
    line-height: 1.1;
    text-shadow: 0 10px 28px rgba(0,0,0,.25);
    margin-bottom: .8rem;
  }

  .login-hero-sub {
    color: rgba(255,255,255,.95);
    text-align: center;
    margin-bottom: 1.8rem;
    font-size: clamp(1rem, .6vw + .8rem, 1.2rem);
  }

  .login-card {
    background: #fff;
    border-radius: 1.5rem;
    padding: 3rem 2.5rem;
    max-width: 480px;
    width: 100%;
    box-shadow: 0 20px 50px rgba(0,0,0,.25);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,.2);
  }

  .form-label{ font-size:.9rem; font-weight:700; color:#334155; margin-bottom:.4rem; display:block; }
  .styled-input{
    width:100%; background:#f8fafc; border:1.5px solid #cbd5e1; border-radius:.85rem;
    padding:.8rem 1rem; font-size:.95rem; transition:.18s;
  }
  .styled-input:focus{ outline:none; border-color:#0d9488; box-shadow:0 0 0 3px rgba(13,148,136,.15); background:#fff; }
  .btn-login{
    width:100%; border:none; border-radius:.9rem; padding:1rem 1.25rem;
    background:linear-gradient(90deg,#0f766e,#0d9488);
    color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(13,148,136,.35);
    transition:.15s ease;
    font-size:1rem;
  }
  .btn-login:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(13,148,136,.45); }

  .login-meta{text-align:center;margin-top:1.5rem;color:#334155;font-size:.95rem;}
  .login-meta a{color:#0d9488;font-weight:800;}
  .login-meta a:hover{text-decoration:underline;}

  .error-box{
    display:none;margin-bottom:1rem;background:linear-gradient(135deg,#fee2e2,#fecaca);
    border:2px solid #ef4444;color:#7f1d1d;border-radius:1rem;padding:1rem 1.2rem;
    font-size:.92rem;font-weight:600;box-shadow:0 8px 16px rgba(239,68,68,.15);
  }

  @keyframes slideInUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
  @keyframes slideOutDown { from { opacity:1; transform:translateY(0); } to { opacity:0; transform:translateY(30px); } }

  #toast{
    position:fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index:60;
    max-width:380px;
    padding:1rem 1.5rem;
    border-radius:1rem;
    font-weight:700;
    font-size:.95rem;
    display:flex;
    align-items:center;
    gap:0.75rem;
    box-shadow:0 16px 32px rgba(0,0,0,.3);
    opacity:0;
    transform:translateY(30px);
    transition:opacity .3s ease, transform .3s ease;
    pointer-events:none;
  }

  #toast.show{
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
    animation:slideInUp .4s cubic-bezier(0.16,1,0.3,1);
  }

  #toast.hide{
    animation:slideOutDown .3s ease forwards;
  }

  #toast::before{
    content:'‚úì';
    font-size:1.3rem;
    font-weight:900;
    flex-shrink:0;
  }

  #toast.error::before{
    content:'‚ö†';
    color:#ef4444;
  }

  #toast.success::before{
    color:#22c55e;
  }
</style>
{% endblock extra_head %}

{% block content %}
<div class="page-center">
  <h1 class="login-hero-title animate-fade-in">Selamat Datang!</h1>
  <p class="login-hero-sub animate-fade-in" style="animation-delay:.08s">Masuk untuk melanjutkan aktivitas olahraga Anda</p>

  <div id="toast" role="status" aria-live="polite"></div>

  <div class="login-card animate-fade-in" style="animation-delay:.12s">
    <div id="login-errors" class="error-box"></div>
    <form id="login-form" method="post" novalidate>
      {% csrf_token %}
      <div class="mb-4">
        <label for="id_username" class="form-label">Username</label>
        {{ form.username }}
      </div>
      <div class="mb-5">
        <label for="id_password" class="form-label">Password</label>
        {{ form.password }}
      </div>
      <button type="submit" class="btn-login">Masuk</button>
    </form>
    <div class="login-meta">
      Belum punya akun? <a href="{% url 'register' %}">Daftar Sekarang</a>
    </div>
  </div>
</div>

<script>
  // Input styling
  (function(){
    const s=(id,ph)=>{const el=document.getElementById(id);if(!el)return;el.classList.add('styled-input');if(ph)el.placeholder=ph;};
    s('id_username','Masukkan username');
    s('id_password','Masukkan password');
  })();

  // Toast util
  function showToast(message, type='success', duration=3500){
    const t = document.getElementById('toast');
    if(!t) return;
    
    t.textContent = message;
    t.className = 'show ' + type;
    
    if (type === 'error') {
      t.style.background = 'linear-gradient(135deg,#fee2e2,#fecaca)';
      t.style.color = '#7f1d1d';
      t.style.boxShadow = '0 16px 32px rgba(239,68,68,.25)';
    } else {
      t.style.background = 'linear-gradient(135deg,#dcfce7,#bbf7d0)';
      t.style.color = '#166534';
      t.style.boxShadow = '0 16px 32px rgba(34,197,94,.25)';
    }
    
    clearTimeout(t._timeout);
    t._timeout = setTimeout(()=>{
      t.classList.remove('show');
      t.classList.add('hide');
      setTimeout(()=>{ t.classList.remove('hide'); }, 300);
    }, duration);
  }

  window.addEventListener('DOMContentLoaded',()=>{
    const raw = localStorage.getItem('toastData');
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      if (obj && obj.trigger === 'after_register_success') {
        showToast(obj.message || 'Registrasi berhasil! Silakan login üëã', obj.type || 'success', obj.duration || 3500);
        localStorage.removeItem('toastData');
      } else {
        const tooOld = Date.now() - (obj.ts || 0) > 120000; // 2 menit
        if (tooOld) localStorage.removeItem('toastData');
      }
    }catch{
      localStorage.removeItem('toastData');
    }
  });

  // AJAX login
  (function(){
    const form=document.getElementById('login-form');
    const errorBox=document.getElementById('login-errors');
    if(!form)return;

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(form);
      try{
        const res=await fetch("",{
          method:"POST",
          headers:{ "X-Requested-With":"XMLHttpRequest","X-CSRFToken":fd.get("csrfmiddlewaretoken") },
          body:fd
        });
        const data=await res.json().catch(()=>({}));

        if(res.ok && data.ok){
          localStorage.setItem('toastData', JSON.stringify({
            message:"Login berhasil! Selamat datang üëã",
            type:'success',
            duration:3500,
            trigger:'after_login_success',
            ts: Date.now()
          }));
          showToast("‚úì Login berhasil! Selamat datang", "success", 1500);
          setTimeout(()=>{ window.location.href=data.redirect || "{% url 'home' %}"; }, 800);
        }else{
          // Format error messages dengan lebih baik
          let errorMessages = [];
          if (data?.errors) {
            Object.entries(data.errors).forEach(([field, msgs])=>{
              const fieldLabel = field.replace(/_/g,' ').toUpperCase();
              if (Array.isArray(msgs)) {
                errorMessages.push(`${fieldLabel}: ${msgs.join(', ')}`);
              } else {
                errorMessages.push(`${fieldLabel}: ${msgs}`);
              }
            });
          }
          
          if (errorMessages.length === 0) {
            errorMessages = ["Username atau password tidak ditemukan"];
          }
          
          errorBox.style.display='block';
          errorBox.innerHTML = errorMessages.map(msg => `<div style="margin-bottom:0.5rem;">‚Ä¢ ${msg}</div>`).join('');
          errorBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          
          const errorMsg = errorMessages[0].toLowerCase().includes('password') 
            ? "‚ùå Password salah" 
            : "‚ùå Username atau password tidak ditemukan";
          showToast(errorMsg, "error", 4000);
        }
      }catch(err){
        errorBox.style.display='block';
        errorBox.innerHTML = '<div style="font-weight:700;">Kesalahan jaringan</div><div style="margin-top:0.3rem;">Pastikan koneksi internet Anda stabil dan coba lagi.</div>';
        errorBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        showToast("‚ùå Kesalahan jaringan. Coba lagi.", "error", 4000);
      }
    });
  })();
</script>
{% endblock content %}
