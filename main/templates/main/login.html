{% extends "base.html" %}
{% load static %}

{% block title %}Login | All-Ahraga{% endblock title %}

{% block extra_head %}
<style>
  @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform:none;} }
  .animate-fade-in { animation: fadeIn .6s ease-out forwards; }

  .bg-img{
    position: fixed; inset: 0; background:url("{% static 'image/bg-court.jpg' %}") center/cover no-repeat;
    filter: blur(6px) saturate(1.05);
    z-index:0;
  }
  .bg-tint{
    position: fixed; inset: 0;
    background: linear-gradient(135deg, rgba(13,148,136,.55), rgba(17,94,89,.65)), rgba(0,0,0,.35);
    mix-blend-mode: multiply; z-index:1;
  }
  header, nav, footer { position: relative; z-index: 5; }

  .page-center{
    position:relative; z-index:2; min-height:80vh;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:3rem 1rem 4rem;
  }

  .login-hero-title{
    color:#fff; text-align:center; font-weight:900;
    font-size:clamp(2.2rem, 2.6vw + 1.4rem, 3.1rem);
    letter-spacing:-0.02em; line-height:1.1;
    text-shadow:0 10px 28px rgba(0,0,0,.35);
    margin-bottom:.8rem;
  }

  .login-hero-sub{
    color:rgba(255,255,255,.92); text-align:center; margin-bottom:1.8rem;
    font-size:clamp(1rem, .6vw + .8rem, 1.2rem);
  }

  .login-card{
    background:#fff;
    border-radius:1.5rem;
    padding:3rem 2.5rem;
    max-width:480px;
    width:100%;
    box-shadow:0 20px 50px rgba(0,0,0,.22);
    transform:scale(1.02);
  }

  .form-label{ font-size:.9rem; font-weight:700; color:#334155; margin-bottom:.4rem; display:block; }
  .styled-input{
    width:100%; background:#f8fafc; border:1.5px solid #cbd5e1; border-radius:.85rem;
    padding:.8rem 1rem; font-size:.95rem; transition:.18s;
  }
  .styled-input:focus{ outline:none; border-color:#0d9488; box-shadow:0 0 0 3px rgba(13,148,136,.15); background:#fff; }
  .btn-login{
    width:100%; border:none; border-radius:.9rem; padding:1rem 1.25rem;
    background:linear-gradient(90deg,#0f766e,#0d9488);
    color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(13,148,136,.35);
    transition:.15s ease;
    font-size:1rem;
  }
  .btn-login:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(13,148,136,.45); }

  .login-meta{text-align:center;margin-top:1.5rem;color:#334155;font-size:.95rem;}
  .login-meta a{color:#0d9488;font-weight:800;}
  .login-meta a:hover{text-decoration:underline;}

  .error-box{
    display:none;margin-bottom:1rem;background:#fee2e2;border:1px solid #fca5a5;
    color:#7f1d1d;border-radius:.85rem;padding:.9rem 1rem;font-size:.9rem;
  }

  :root { --header-h: 4rem; }
  #toast{
    position:fixed;
    top:calc(var(--header-h) + .75rem);
    right:1.25rem;
    z-index:60;
    min-width:280px; max-width:360px;
    padding:.9rem 1rem; border-radius:.9rem; color:#fff;
    background:linear-gradient(90deg,#059669,#0d9488);
    box-shadow:0 14px 30px rgba(0,0,0,.25);
    opacity:0; transform:translateY(-10px);
    transition:opacity .25s ease, transform .25s ease;
    font-weight:600;
  }
  #toast.show{ opacity:1; transform:translateY(0); }
</style>
{% endblock extra_head %}

{% block content %}
<div class="bg-img"></div>
<div class="bg-tint"></div>

<div class="page-center">
  <h1 class="login-hero-title animate-fade-in">Selamat Datang!</h1>
  <p class="login-hero-sub animate-fade-in" style="animation-delay:.08s">Masuk untuk melanjutkan aktivitas olahraga Anda</p>

  <div id="toast" role="status" aria-live="polite"></div>

  <div class="login-card animate-fade-in" style="animation-delay:.12s">
    <div id="login-errors" class="error-box"></div>
    <form id="login-form" method="post" novalidate>
      {% csrf_token %}
      <div class="mb-4">
        <label for="id_username" class="form-label">Username</label>
        {{ form.username }}
      </div>
      <div class="mb-5">
        <label for="id_password" class="form-label">Password</label>
        {{ form.password }}
      </div>
      <button type="submit" class="btn-login">Masuk</button>
    </form>
    <div class="login-meta">
      Belum punya akun? <a href="{% url 'register' %}">Daftar Sekarang</a>
    </div>
  </div>
</div>

<script>
  // Input styling
  (function(){
    const s=(id,ph)=>{const el=document.getElementById(id);if(!el)return;el.classList.add('styled-input');if(ph)el.placeholder=ph;};
    s('id_username','Masukkan username');
    s('id_password','Masukkan password');
  })();

  // Toast util
  function showToast(message,type='success',duration=3000){
    const t=document.getElementById('toast');
    if(!t)return;
    t.textContent=message;
    t.style.background=(type==='error')
      ?'linear-gradient(90deg,#b91c1c,#dc2626)'
      :'linear-gradient(90deg,#059669,#0d9488)';
    t.classList.add('show');
    clearTimeout(t._timeout);
    t._timeout=setTimeout(()=>{t.classList.remove('show');},duration);
  }

  window.addEventListener('DOMContentLoaded',()=>{
    const raw = localStorage.getItem('toastData');
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      if (obj && obj.trigger === 'after_register_success') {
        showToast(obj.message || 'Registrasi berhasil! Silakan login ðŸ‘‹', obj.type || 'success', obj.duration || 3500);
        localStorage.removeItem('toastData');
      } else {
        const tooOld = Date.now() - (obj.ts || 0) > 120000; // 2 menit
        if (tooOld) localStorage.removeItem('toastData');
      }
    }catch{
      localStorage.removeItem('toastData');
    }
  });

  // AJAX login
  (function(){
    const form=document.getElementById('login-form');
    const errorBox=document.getElementById('login-errors');
    if(!form)return;

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(form);
      try{
        const res=await fetch("",{
          method:"POST",
          headers:{ "X-Requested-With":"XMLHttpRequest","X-CSRFToken":fd.get("csrfmiddlewaretoken") },
          body:fd
        });
        const data=await res.json().catch(()=>({}));

        if(res.ok && data.ok){
          localStorage.setItem('toastData', JSON.stringify({
            message:"Login berhasil! Selamat datang ðŸ‘‹",
            type:'success',
            duration:3500,
            trigger:'after_login_success',
            ts: Date.now()
          }));
          window.location.href=data.redirect || "{% url 'home' %}";
        }else{
          const messages=data?.errors ? Object.values(data.errors).flat() : ["Login gagal."];
          errorBox.style.display='block';
          errorBox.innerHTML=messages.join('<br>');
          showToast("Login gagal, periksa kembali data Anda.","error",3200);
        }
      }catch(err){
        showToast("Kesalahan jaringan.","error",3200);
      }
    });
  })();
</script>
{% endblock content %}
