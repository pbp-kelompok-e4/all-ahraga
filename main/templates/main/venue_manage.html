{% extends "base.html" %}

{% block title %}Kelola: {{ venue.name }}{% endblock title %}

{% block content %}
<style>
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; margin: 20px auto; }
    .grid-item { background-color: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .grid-item h3 { margin-top: 0; }
    form p { margin-bottom: 10px; }
    form label { display: block; margin-bottom: 5px; font-weight: bold; }
    form input, form select, form textarea { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
</style>

<div style="max-width: 1200px; margin: 20px auto;">
    <h2>Manage Venue: {{ venue.name }}</h2>
    <p><a href="{% url 'venue_dashboard' %}">&larr; Back</a></p>
    
    <div id="message-container" style="margin: 15px 0;"></div>
</div>

<div class="grid-container">
    <div class="grid-item">
        <h3>Edit Venue</h3>
        <form id="venue-edit-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ venue_edit_form.as_p }}
            <button type="submit" name="submit_venue_edit" style="padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Save Changes
            </button>
        </form>

        <hr style="margin: 25px 0;">

        <h3>Manage Venue Schedule</h3>
        <p>Kelola slot jam, ketersediaan, dan lakukan penghapusan jadwal massal di halaman terpisah.</p>
        <a href="{% url 'venue_manage_schedule' venue_id=venue.id %}" 
           style="display: block; text-align: center; padding: 10px; background-color: #f97316; color: white; border-radius: 4px; margin-top: 10px; text-decoration: none; font-weight: bold;">
            Kelola Jadwal Lapangan â†’
        </a>
    </div>

    <div class="grid-item">
        <h3>Manage Equipment</h3>
        <p>Add equipments that can be rented on this venue.</p>
        <form id="equipment-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="submit_equipment" value="1">
            {{ equipment_form.as_p }}
            <button type="submit" style="padding: 10px; background-color: #28a848; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                + Add Equipment
            </button>
        </form>

        <h4 style="margin-top: 20px;">Equipment List:</h4>
        <ul id="equipment-list" style="max-height: 200px; overflow-y: auto; padding-left: 20px;">
            {% for item in equipments %}
                <li>
                    {{ item.name }} (Stock: {{ item.stock_quantity }}) - Rp {{ item.rental_price|floatformat:0 }}/rental
                </li>
            {% empty %}
                <li>Belum ada equipment.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const venueEditForm = document.getElementById('venue-edit-form');
    const equipmentForm = document.getElementById('equipment-form');
    
    venueEditForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const csrfToken = '{{ csrf_token }}';
        
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
            } else {
                let errorMsg = 'Terjadi kesalahan: ';
                for (let field in data.errors) {
                    errorMsg += data.errors[field].join(', ') + ' ';
                }
                showMessage(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Terjadi kesalahan saat menyimpan perubahan.', 'error');
        });
    });
    
    equipmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const csrfToken = '{{ csrf_token }}';
        
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                
                const equipmentList = document.getElementById('equipment-list');
                equipmentList.innerHTML = '';
                
                if (data.equipments.length > 0) {
                    data.equipments.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = `${item.name} (Stock: ${item.stock}) - Rp ${item.price.toFixed(0)}/rental`;
                        equipmentList.appendChild(li);
                    });
                } else {
                    equipmentList.innerHTML = '<li>Belum ada equipment.</li>';
                }
                
                equipmentForm.reset();
            } else {
                let errorMsg = 'Terjadi kesalahan: ';
                for (let field in data.errors) {
                    errorMsg += data.errors[field].join(', ') + ' ';
                }
                showMessage(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Terjadi kesalahan saat menambahkan equipment.', 'error');
        });
    });
    
    function showMessage(message, type) {
        const container = document.getElementById('message-container');
        const color = type === 'success' ? '#28a745' : '#dc3545';
        container.innerHTML = `<div style="padding: 10px; background-color: ${color}; color: white; border-radius: 5px;">${message}</div>`;
        
        setTimeout(() => {
            container.innerHTML = '';
        }, 3000);
    }
});
</script>
{% endblock content %}