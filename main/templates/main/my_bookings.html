{% extends "base.html" %}

{% block title %}Bookingan Saya{% endblock title %}

{% block extra_head %}
<style>
    /* Custom utility to animate opacity and translateY */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    
    .input-wrapper { @apply relative; } 
    .input-icon { @apply absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none; } 

    /* Toast styles */
    /* Pastikan style toast Anda (user-toast, user-slide-in, etc.) didefinisikan di sini */
    /* Contoh Minimal */
     .user-toast { 
        position: fixed; top: 1rem; right: 1rem; z-index: 100;
        min-width: 250px; max-width: 400px;
        background-color: #333; color: white;
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.75rem 1rem; /* p-3 p-4 */
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); /* shadow-md */
        opacity: 0; transform: translateX(100%);
        transition: opacity 0.3s ease, transform 0.3s ease;
        display: flex; align-items: center; gap: 0.75rem; /* gap-3 */
     }
     .user-toast.show { opacity: 1; transform: translateX(0); }
     .user-toast.success { background-color: #10B981; } /* emerald-500 */
     .user-toast.error { background-color: #EF4444; } /* red-500 */
     .user-toast.info { background-color: #3B82F6; } /* blue-500 */
     .user-toast.warning { background-color: #F59E0B; } /* amber-500 */
     .user-toast-content { display: flex; align-items: center; flex-grow: 1; }
     .user-toast-content .icon { font-size: 1.25rem; /* text-xl */ margin-right: 0.5rem; /* mr-2 */ }
     .user-toast-content .message { font-size: 0.875rem; /* text-sm */ }
     .user-toast .close-btn { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; padding: 0.25rem; margin-left: auto; }
     .user-toast .close-btn:hover { opacity: 1; }
     /* Pastikan @keyframes didefinisikan jika Anda menggunakannya */


    /* Modal Animation */
    @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modalSlideUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    #editBookingModal:not(.hidden) { display: flex; animation: modalFadeIn 0.3s ease forwards; }
    #editBookingModal > div { animation: modalSlideUp 0.3s ease forwards; }

</style>
{% endblock extra_head %}

{% block content %}
{# ✅ Class background gradient DIHAPUS dari div ini #}
<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8"> 
    <div class="max-w-5xl mx-auto"> 
        
        <div class="relative overflow-hidden bg-gradient-to-r from-teal-600 via-teal-700 to-cyan-700 rounded-2xl shadow-xl mb-8 transform hover:scale-[1.01] transition-transform duration-300 animate-fade-in">
             <div class="absolute inset-0 bg-black opacity-10"></div>
             <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-32 -mt-32"></div>
             <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-5 rounded-full -ml-24 -mb-24"></div>
            <div class="relative p-8">
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 p-3 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl shadow-lg">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    </div>
                    <div class="flex-grow">
                        <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">Bookingan Saya</h1>
                        <p class="text-teal-50 text-base sm:text-lg">Lihat dan kelola booking aktif Anda.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-gray-100 animate-fade-in">
            <div class="flex flex-col sm:flex-row gap-4"> 
                <div class="flex-grow relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" 
                           id="searchMyBooking" 
                           placeholder="Cari nama venue atau ID booking..."
                           class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200 text-gray-700 placeholder-gray-400">
                </div>
            </div>
        </div>
        
        <div id="bookingListWrapper"> 
            {% include "main/_my_booking_list.html" %}
        </div>
    </div>
</div>

<div id="editBookingModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50 overflow-y-auto p-4 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative animate-slideUp"> 
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Edit Booking</h3> 
        <form id="editBookingForm">
            {% csrf_token %}
            <input type="hidden" id="editBookingId">
            <div class="space-y-4 mb-6">
                <div>
                    <label for="editSchedule" class="block mb-1 text-sm font-medium text-gray-700">Pilih Jadwal Baru:</label>
                    <select id="editSchedule" name="schedule_id" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 text-sm"></select>
                </div>
                <div>
                    <label for="editCoach" class="block mb-1 text-sm font-medium text-gray-700">Pilih Coach (opsional):</label>
                    <select id="editCoach" name="coach_id" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 text-sm">
                        <option value="">Tanpa Coach</option>
                    </select>
                </div>
                
                <div>
                    <label for="editPaymentMethod" class="block mb-1 text-sm font-medium text-gray-700">Metode Pembayaran:</label>
                    <select id="editPaymentMethod" name="payment_method" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 text-sm">
                        <option value="CASH">Cash (Bayar di Tempat)</option>
                        <option value="CARD">Transfer Bank (Virtual Account)</option>
                        </select>
                </div>
                
                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">Pilih Peralatan:</label>
                    <div id="editEquipmentList" class="space-y-2 max-h-48 overflow-y-auto pr-2 border p-3 rounded-lg bg-gray-50">
                        {# Konten diisi JS #}
                    </div>
                </div>
            </div>
            </form>
        <button onclick="closeEditModal()" class="absolute top-3 right-3 p-1.5 rounded-full text-gray-400 bg-gray-100 hover:bg-gray-200 hover:text-gray-600 transition-colors"> <i class="fa-solid fa-xmark text-lg"></i> </button>
    </div>
</div>

<div id="user-toast-container" class="fixed top-4 right-4 z-[100] space-y-3"></div>
{% endblock content %}

{% block extra_js %}
<script>
// --- Fungsi showUserToast (Pastikan didefinisikan dengan benar) ---
function showUserToast(message, type = 'info') {
    const container = document.getElementById('user-toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `user-toast ${type}`; // Apply type class for styling

    let iconHtml = '';
    if (type === 'success') iconHtml = '<i class="fas fa-check-circle icon"></i>';
    else if (type === 'error') iconHtml = '<i class="fas fa-times-circle icon"></i>';
    else if (type === 'warning') iconHtml = '<i class="fas fa-exclamation-triangle icon"></i>';
    else iconHtml = '<i class="fas fa-info-circle icon"></i>';

    toast.innerHTML = `
        <div class="user-toast-content">
            ${iconHtml}
            <span class="message">${message}</span>
        </div>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
    `;

    container.appendChild(toast);
    toast.classList.add('show'); // Trigger animation

    // Auto-remove after some time
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300); // Remove after fade out
    }, 4000); // Show for 4 seconds
}


// --- DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', function() {
  {% if messages %}
    {% for message in messages %}
      let toastType = 'info'; 
      {% if message.tags == 'success' %} toastType = 'success';
      {% elif message.tags == 'error' %} toastType = 'error';
      {% elif message.tags == 'warning' %} toastType = 'warning';
      {% endif %}
      showUserToast("{{ message|escapejs }}", toastType);
    {% endfor %}
  {% endif %}
});


// ======================================================
// ✅ AWAL DARI LOGIKA MODAL YANG HILANG
// ======================================================
const modal = document.getElementById('editBookingModal');
const form = document.getElementById('editBookingForm');
const bookingIdInput = document.getElementById('editBookingId');
const scheduleSelect = document.getElementById('editSchedule');
const coachSelect = document.getElementById('editCoach');
const equipmentListDiv = document.getElementById('editEquipmentList');

// --- Fungsi untuk memuat coach yang tersedia ---
async function loadCoachesForSchedule(scheduleId, bookingId, currentCoachId = null) {
    // Bangun URL dengan benar, pastikan 'schedule_id_placeholder' diganti
    let urlTemplate = "{% url 'get_available_coaches' schedule_id=99999 %}".replace('99999', scheduleId);
    const url = new URL(urlTemplate, window.location.origin);
    url.searchParams.append('editing_booking_id', bookingId);
    
    coachSelect.innerHTML = '<option value="">Memuat coach...</option>';
    coachSelect.disabled = true;

    try {
        const response = await fetch(url.toString());
        if (!response.ok) throw new Error('Gagal memuat data coach.');
        
        const data = await response.json();
        
        coachSelect.innerHTML = '<option value="">Tanpa Coach</option>'; // Default
        data.coaches.forEach(coach => {
            const isSelected = currentCoachId && coach.id == currentCoachId;
            coachSelect.innerHTML += `<option value="${coach.id}" ${isSelected ? 'selected' : ''}>
                ${coach.name} - Rp ${parseInt(coach.rate_per_hour).toLocaleString('id-ID')}
            </option>`;
        });
        
        coachSelect.disabled = false;

    } catch (error) {
        console.error('Error loading coaches:', error);
        coachSelect.innerHTML = '<option value="">Gagal memuat coach</option>';
    }
}

// --- Fungsi untuk membuka dan mengisi modal ---
async function openEditModal(bookingId) {
    if (!modal || !form) return;
    
    // Reset form & set booking ID
    form.reset();
    bookingIdInput.value = bookingId;
    scheduleSelect.innerHTML = '<option value="">Memuat jadwal...</option>';
    coachSelect.innerHTML = '<option value="">Pilih jadwal dulu</option>';
    equipmentListDiv.innerHTML = '<div class="text-gray-500 text-sm">Memuat peralatan...</div>';
    
    // Tampilkan modal
    modal.classList.remove('hidden');

    try {
        // 1. Ambil data booking
        // Pastikan 'booking_id_placeholder' diganti
        let urlTemplate = "{% url 'update_booking_data' booking_id=99999 %}".replace('99999', bookingId);
        const response = await fetch(urlTemplate);
        
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.message || 'Gagal mengambil data booking.');
        }

        // 2. Isi Jadwal (Schedules)
        const currentSchedule = data.current_schedule;
        let scheduleOptions = `<option value="${currentSchedule.id}" selected>
            (Saat ini) ${currentSchedule.date_str_display} | ${currentSchedule.start_time} - ${currentSchedule.end_time}
        </option>`;
        data.schedules.forEach(s => {
            scheduleOptions += `<option value="${s.id}">
                ${s.date_str_display} | ${s.start_time} - ${s.end_time}
            </option>`;
        });
        scheduleSelect.innerHTML = scheduleOptions;

        // 3. Isi Peralatan (Equipment)
        equipmentListDiv.innerHTML = '';
        if (data.available_equipments.length > 0) {
            data.available_equipments.forEach(eq => {
                const currentQuantity = data.selected_equipment_map[eq.id] || 0;
                equipmentListDiv.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded-md border border-gray-200">
                        <label for="eq_${eq.id}" class="flex-grow text-sm font-medium text-gray-700">
                            ${eq.name} (Rp ${parseInt(eq.price).toLocaleString('id-ID')})
                        </label>
                        <div class="flex items-center space-x-2">
                             <input type="checkbox" id="eq_${eq.id}" name="equipment" value="${eq.id}" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" ${currentQuantity > 0 ? 'checked' : ''}>
                             <input type="number" name="quantity_${eq.id}" value="${currentQuantity || 1}" min="1" max="${eq.stock_quantity}" class="w-16 p-1 border border-gray-300 rounded-md text-sm text-center" ${currentQuantity == 0 ? 'style="display:none;"' : ''}>
                        </div>
                    </div>
                `;
            });
            // Tambah event listener untuk show/hide input quantity
            equipmentListDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const qtyInput = equipmentListDiv.querySelector(`input[name="quantity_${e.target.value}"]`);
                    if (qtyInput) {
                        qtyInput.style.display = e.target.checked ? 'block' : 'none';
                    }
                });
            });

        } else {
            equipmentListDiv.innerHTML = '<div class="text-gray-500 text-sm">Tidak ada peralatan tersedia untuk venue ini.</div>';
        }

        if (data.current_payment_method) {
            const paymentSelect = document.getElementById('editPaymentMethod');
            if (paymentSelect) {
                paymentSelect.value = data.current_payment_method;
            }
        }
        
        // 4. Muat Coach (berdasarkan jadwal yang dipilih saat ini)
        await loadCoachesForSchedule(currentSchedule.id, bookingId, data.current_coach_id);

    } catch (error) {
        console.error('Error opening edit modal:', error);
        showUserToast(`Error: ${error.message}`, 'error');
        closeEditModal();
    }
}

// --- Fungsi untuk menutup modal ---
function closeEditModal() {
    if (modal) modal.classList.add('hidden');
}

// --- Event Listener untuk Perubahan Jadwal ---
if (scheduleSelect) {
    scheduleSelect.addEventListener('change', async function() {
        const scheduleId = this.value;
        const bookingId = bookingIdInput.value;
        if (scheduleId && bookingId) {
            // Muat ulang daftar coach, tapi jangan pilih coach lama (karena jadwal beda)
            await loadCoachesForSchedule(scheduleId, bookingId, null);
        } else {
            coachSelect.innerHTML = '<option value="">Pilih jadwal dulu</option>';
            coachSelect.disabled = true;
        }
    });
}

// --- Event Listener untuk Submit Form Edit ---
if (form) {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const bookingId = bookingIdInput.value;
        if (!bookingId) return;

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = 'Menyimpan...';

        const formData = new FormData(form);
        // Pastikan equipment yang tidak dicheck tidak mengirim quantity
        equipmentListDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            if (!cb.checked) {
                formData.delete(`quantity_${cb.value}`);
            }
        });

        try {
            // Pastikan 'booking_id_placeholder' diganti
            let urlTemplate = "{% url 'update_booking' booking_id=99999 %}".replace('99999', bookingId);
            const response = await fetch(urlTemplate, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                    // CSRF token sudah di-handle oleh {% csrf_token %} dalam FormData
                }
            });

            const data = await response.json();

            if (data.success) {
                showUserToast(data.message || 'Booking berhasil diperbarui.', 'success');
                // Beri waktu toast untuk tampil sebelum reload
                setTimeout(() => {
                    window.location.href = data.redirect_url || "{% url 'my_bookings' %}";
                }, 1000);
            } else {
                throw new Error(data.message || 'Terjadi kesalahan.');
            }

        } catch (error) {
            console.error('Error updating booking:', error);
            showUserToast(error.message, 'error');
            submitButton.disabled = false;
            submitButton.innerHTML = 'Simpan Perubahan';
        }
    });
}
// ======================================================
// ✅ AKHIR DARI LOGIKA MODAL
// ======================================================


// --- Event Listener Search ---
const searchInput = document.getElementById('searchMyBooking');
const bookingListWrapper = document.getElementById('bookingListWrapper');
const dataUrl = "{% url 'my_bookings' %}"; // Ganti jika perlu view AJAX
let debounceTimer;
function debounce(func, delay) { return function(...args) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { func.apply(this, args); }, delay); }; }
async function fetchMyBookings() {
    const searchTerm = searchInput.value;
    const url = new URL(dataUrl, window.location.origin);
    if (searchTerm) url.searchParams.append('q', searchTerm);

    try {
        bookingListWrapper.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-teal-600 mb-4"></i><p class="text-gray-500 font-medium">Memuat bookingan Anda...</p></div>`;
        const response = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'text/html' } });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const html = await response.text();
        bookingListWrapper.innerHTML = html;
        window.history.replaceState({}, '', url.toString());
    } catch (error) {
        console.error('Error fetching my bookings:', error);
        bookingListWrapper.innerHTML = `<div class="text-center p-10 bg-red-50 text-red-700 rounded-lg border border-red-200"><p class="font-semibold mb-2">Oops! Gagal memuat data.</p><p class="text-sm">Silakan coba refresh halaman.</p></div>`;
    }
}
if (searchInput) { searchInput.addEventListener('input', debounce(fetchMyBookings, 350)); }

</script>
{% endblock extra_js %}