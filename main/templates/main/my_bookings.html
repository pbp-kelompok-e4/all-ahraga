{% extends "base.html" %}

{% block title %}Bookingan Saya{% endblock title %}

{% block content %}
<div class="max-w-[900px] mx-auto my-5 p-6 bg-white rounded-lg shadow">
    {% if bookings %}
        <p class="text-center mb-6">Berikut adalah daftar booking Anda yang menunggu konfirmasi pembayaran.</p>
        <ul class="space-y-5">
            {% for booking in bookings %}
                <li class="border border-gray-200 rounded-lg p-5 bg-gray-50">
                    <h4 class="text-lg mb-3">
                        Booking #{{ booking.id }} - 
                        <strong>{{ booking.venue_schedule.venue.name }}</strong>
                    </h4>
                    
                    <p class="mb-2">
                        <strong>Jadwal:</strong> 
                        {{ booking.venue_schedule.date|date:"l, d F Y" }}
                    </p>
                    <p class="mb-2">
                        <strong>Total Biaya:</strong> Rp {{ booking.total_price }}
                    </p>
                    <p class="mb-2">
                        <strong>Metode Pembayaran:</strong> {{ booking.transaction.payment_method }}
                    </p>
                    <p class="mb-4">
                        <strong>Status Pembayaran:</strong> 
                        <span class="font-bold text-orange-500">
                            MENUNGGU PEMBAYARAN
                        </span>
                    </p>
                    
                    <div class="flex gap-3">
                        <a href="{% url 'customer_payment' booking.id %}" 
                           class="px-4 py-2 bg-green-600 text-white font-semibold rounded hover:bg-green-700 transition-colors">
                            Bayar Sekarang
                        </a>
                        <a href="{% url 'delete_booking' booking.id %}" 
                           class="px-4 py-2 bg-red-600 text-white font-semibold rounded hover:bg-red-700 transition-colors"
                           onclick="return confirm('Apakah Anda yakin ingin membatalkan booking ini?');">
                            Cancel Booking
                        </a>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-center text-green-600 font-bold">
            Tidak ada booking yang menunggu pembayaran. Semua booking Anda sudah lunas! üëç
        </p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Delete booking without reload
    document.querySelectorAll('.delete-booking').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Yakin ingin membatalkan booking ini?')) {
                fetch(this.href, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        this.closest('li').remove();
                    }
                });
            }
        });
    });

    // Real-time status updates using WebSocket
    const bookingSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/bookings/'
    );
    
    bookingSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        updateBookingStatus(data.booking_id, data.status);
    };
});
</script>
{% endblock content %}