{% extends "base.html" %}

{% block title %}Bookingan Saya{% endblock title %}

{% block extra_head %}
<style>
    /* Custom utility to animate opacity and translateY */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    
    .input-wrapper { @apply relative; } 
    .input-icon { @apply absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none; } 

     .user-toast { 
        position: relative; 
        min-width: 280px; max-width: 400px;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.15);
        opacity: 0; 
        transform: translateY(100%);
        transition: opacity 0.3s ease, transform 0.3s ease;
        display: flex; align-items: center; gap: 0.75rem;
        color: white;
        font-weight: 600;
     }
     .user-toast.show { opacity: 1; transform: translateY(0); } 
     .user-toast.success { 
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
     }
     .user-toast.error { 
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
     }
     .user-toast.info { 
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
     }
     .user-toast.warning { 
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
     }
     .user-toast-content { display: flex; align-items: center; flex-grow: 1; gap: 0.5rem; }
     .user-toast-content .icon { font-size: 1.5rem; }
     .user-toast-content .message { font-size: 0.95rem; line-height: 1.4; }
     .user-toast .close-btn { 
        background: none; border: none; color: white; 
        opacity: 0.9; cursor: pointer; padding: 0.25rem; 
        margin-left: auto; font-size: 1.5rem; font-weight: bold;
        transition: opacity 0.2s;
     }
     .user-toast .close-btn:hover { opacity: 1; transform: scale(1.1); }


    /* Modal Animation */
    @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modalSlideUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    #editBookingModal:not(.hidden) { display: flex; animation: modalFadeIn 0.3s ease forwards; }
    #editBookingModal > div { animation: modalSlideUp 0.3s ease forwards; }
    
    /* Confirm Delete Modal Animation */
    #confirmDeleteModal:not(.hidden) { display: flex; animation: modalFadeIn 0.3s ease forwards; }
    #confirmDeleteModal > div { animation: modalSlideUp 0.3s ease forwards; }

</style>
{% endblock extra_head %}

{% block content %}
<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8"> 
    <div class="max-w-5xl mx-auto"> 
        
        <div class="relative overflow-hidden bg-gradient-to-r from-teal-600 via-teal-700 to-cyan-700 rounded-2xl shadow-xl mb-8 transform hover:scale-[1.01] transition-transform duration-300 animate-fade-in">
             <div class="absolute inset-0 bg-black opacity-10"></div>
             <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-32 -mt-32"></div>
             <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-5 rounded-full -ml-24 -mb-24"></div>
            <div class="relative p-8">
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 p-3 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl shadow-lg">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    </div>
                    <div class="flex-grow">
                        <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">Bookingan Saya</h1>
                        <p class="text-teal-50 text-base sm:text-lg">Lihat dan kelola booking aktif Anda.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-gray-100 animate-fade-in">
            <div class="flex flex-col sm:flex-row gap-4"> 
                <div class="flex-grow relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" 
                           id="searchMyBooking" 
                           placeholder="Cari nama venue atau ID booking..."
                           class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200 text-gray-700 placeholder-gray-400">
                </div>
            </div>
        </div>
        
        <div id="bookingListWrapper"> 
            {% include "main/_my_booking_list.html" %}
        </div>
    </div>
</div>

<!-- Edit Booking Modal -->
<div id="editBookingModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50 overflow-y-auto p-4 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative animate-slideUp"> 
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Edit Booking</h3> 
        <form id="editBookingForm">
            {% csrf_token %}
            <input type="hidden" id="editBookingId">
            <div class="space-y-4 mb-6">
                <div>
                    <label for="editSchedule" class="block mb-1 text-sm font-medium text-gray-700">Pilih Jadwal Baru:</label>
                    <select id="editSchedule" name="schedule_id" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 text-sm"></select>
                </div>
                <div>
                    <label for="editCoach" class="block mb-1 text-sm font-medium text-gray-700">Pilih Coach (opsional):</label>
                    <select id="editCoach" name="coach_id" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 text-sm">
                        <option value="">Tanpa Coach</option>
                    </select>
                </div>
                
                <div>
                    <label for="editPaymentMethod" class="block mb-1 text-sm font-medium text-gray-700">Metode Pembayaran:</label>
                    <select id="editPaymentMethod" name="payment_method" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-teal-500 focus:border-teal-500 text-sm">
                        <option value="CASH">Cash (Bayar di Tempat)</option>
                        <option value="TRANSFER">Transfer Bank (Virtual Account)</option>
                        </select>
                </div>
                
                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-700">Pilih Peralatan:</label>
                    <div id="editEquipmentList" class="space-y-2 max-h-48 overflow-y-auto pr-2 border p-3 rounded-lg bg-gray-50">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                <button type="button" 
                        onclick="closeEditModal()" 
                        class="px-5 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    Batal
                </button>
                <button type="submit" 
                        class="px-5 py-2.5 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors shadow-sm">
                    Simpan Perubahan
                </button>
            </div>
            </form>
        <button onclick="closeEditModal()" class="absolute top-3 right-3 p-1.5 rounded-full text-gray-400 bg-gray-100 hover:bg-gray-200 hover:text-gray-600 transition-colors"> <i class="fa-solid fa-xmark text-lg"></i> </button>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60] backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 mx-4">
        <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Konfirmasi Pembatalan</h3>
        <p class="text-gray-600 text-center mb-6">
            Apakah Anda yakin ingin membatalkan booking untuk <span id="deleteVenueName" class="font-semibold text-gray-900"></span>?
        </p>
        <div class="flex gap-3">
            <button type="button" 
                    onclick="closeDeleteModal()" 
                    class="flex-1 px-4 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                Tidak, Kembali
            </button>
            <button type="button" 
                    id="confirmDeleteBtn"
                    class="flex-1 px-4 py-2.5 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-sm">
                Ya, Batalkan
            </button>
        </div>
    </div>
</div>

<div id="user-toast-container" class="fixed bottom-4 right-4 z-[100] space-y-3"></div>
{% endblock content %}

{% block extra_js %}
<script>
function showUserToast(message, type = 'info') {
    const container = document.getElementById('user-toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `user-toast ${type}`; 

    let iconHtml = '';
    if (type === 'success') iconHtml = '<i class="fas fa-check-circle icon"></i>';
    else if (type === 'error') iconHtml = '<i class="fas fa-times-circle icon"></i>';
    else if (type === 'warning') iconHtml = '<i class="fas fa-exclamation-triangle icon"></i>';
    else iconHtml = '<i class="fas fa-info-circle icon"></i>';

    toast.innerHTML = `
        <div class="user-toast-content">
            ${iconHtml}
            <span class="message">${message}</span>
        </div>
        <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
    `;

    container.appendChild(toast);
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300); 
    }, 4000);
}


// --- DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', function() {
  {% if messages %}
    {% for message in messages %}
      let toastType = 'info'; 
      {% if message.tags == 'success' %} toastType = 'success';
      {% elif message.tags == 'error' %} toastType = 'error';
      {% elif message.tags == 'warning' %} toastType = 'warning';
      {% endif %}
      showUserToast("{{ message|escapejs }}", toastType);
    {% endfor %}
  {% endif %}
});

const urlParams = new URLSearchParams(window.location.search);
  const toastMsg = urlParams.get('toast_msg');
  const toastType = urlParams.get('toast_type');
  
  if (toastMsg && toastType) {
      showUserToast(toastMsg, toastType);
      window.history.replaceState(null, '', window.location.pathname);
  }

const modal = document.getElementById('editBookingModal');
const form = document.getElementById('editBookingForm');
const bookingIdInput = document.getElementById('editBookingId');
const scheduleSelect = document.getElementById('editSchedule');
const coachSelect = document.getElementById('editCoach');
const equipmentListDiv = document.getElementById('editEquipmentList');

async function loadCoachesForSchedule(scheduleId, bookingId, currentCoachId = null) {
    let urlTemplate = "{% url 'get_available_coaches' schedule_id=99999 %}".replace('99999', scheduleId);
    const url = new URL(urlTemplate, window.location.origin);
    url.searchParams.append('editing_booking_id', bookingId);
    
    coachSelect.innerHTML = '<option value="">Memuat coach...</option>';
    coachSelect.disabled = true;

    try {
        const response = await fetch(url.toString());
        if (!response.ok) throw new Error('Gagal memuat data coach.');
        
        const data = await response.json();
        
        coachSelect.innerHTML = '<option value="">Tanpa Coach</option>'; 
        data.coaches.forEach(coach => {
            const isSelected = currentCoachId && coach.id == currentCoachId;
            coachSelect.innerHTML += `<option value="${coach.id}" ${isSelected ? 'selected' : ''}>
                ${coach.name} - Rp ${parseInt(coach.rate_per_hour).toLocaleString('id-ID')}
            </option>`;
        });
        
        coachSelect.disabled = false;

    } catch (error) {
        console.error('Error loading coaches:', error);
        coachSelect.innerHTML = '<option value="">Gagal memuat coach</option>';
    }
}

async function openEditModal(bookingId) {
    if (!modal || !form) return;
    
    form.reset();
    bookingIdInput.value = bookingId;
    scheduleSelect.innerHTML = '<option value="">Memuat jadwal...</option>';
    coachSelect.innerHTML = '<option value="">Pilih jadwal dulu</option>';
    equipmentListDiv.innerHTML = '<div class="text-gray-500 text-sm">Memuat peralatan...</div>';
    
    modal.classList.remove('hidden');

    try {
        let urlTemplate = "{% url 'update_booking_data' booking_id=99999 %}".replace('99999', bookingId);
        const response = await fetch(urlTemplate);
        
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.message || 'Gagal mengambil data booking.');
        }

        const currentSchedule = data.current_schedule;
        let scheduleOptions = `<option value="${currentSchedule.id}" selected>
            (Saat ini) ${currentSchedule.date_str_display} | ${currentSchedule.start_time} - ${currentSchedule.end_time}
        </option>`;
        data.schedules.forEach(s => {
            scheduleOptions += `<option value="${s.id}">
                ${s.date_str_display} | ${s.start_time} - ${s.end_time}
            </option>`;
        });
        scheduleSelect.innerHTML = scheduleOptions;

        equipmentListDiv.innerHTML = '';
        if (data.available_equipments.length > 0) {
            data.available_equipments.forEach(eq => {
                const currentQuantity = data.selected_equipment_map[eq.id] || 0;
                equipmentListDiv.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded-md border border-gray-200">
                        <label for="eq_${eq.id}" class="flex-grow text-sm font-medium text-gray-700">
                            ${eq.name} (Rp ${parseInt(eq.price).toLocaleString('id-ID')})
                        </label>
                        <div class="flex items-center space-x-2">
                             <input type="checkbox" id="eq_${eq.id}" name="equipment" value="${eq.id}" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" ${currentQuantity > 0 ? 'checked' : ''}>
                             <input type="number" name="quantity_${eq.id}" value="${currentQuantity || 1}" min="1" max="${eq.stock_quantity}" class="w-16 p-1 border border-gray-300 rounded-md text-sm text-center" ${currentQuantity == 0 ? 'style="display:none;"' : ''}>
                        </div>
                    </div>
                `;
            });
            equipmentListDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const qtyInput = equipmentListDiv.querySelector(`input[name="quantity_${e.target.value}"]`);
                    if (qtyInput) {
                        qtyInput.style.display = e.target.checked ? 'block' : 'none';
                    }
                });
            });

        } else {
            equipmentListDiv.innerHTML = '<div class="text-gray-500 text-sm">Tidak ada peralatan tersedia untuk venue ini.</div>';
        }

        if (data.current_payment_method) {
            const paymentSelect = document.getElementById('editPaymentMethod');
            if (paymentSelect) {
                paymentSelect.value = data.current_payment_method;
            }
        }
        
        await loadCoachesForSchedule(currentSchedule.id, bookingId, data.current_coach_id);

    } catch (error) {
        console.error('Error opening edit modal:', error);
        showUserToast(`Error: ${error.message}`, 'error');
        closeEditModal();
    }
}

function closeEditModal() {
    if (modal) modal.classList.add('hidden');
}

if (scheduleSelect) {
    scheduleSelect.addEventListener('change', async function() {
        const scheduleId = this.value;
        const bookingId = bookingIdInput.value;
        if (scheduleId && bookingId) {
            await loadCoachesForSchedule(scheduleId, bookingId, null);
        } else {
            coachSelect.innerHTML = '<option value="">Pilih jadwal dulu</option>';
            coachSelect.disabled = true;
        }
    });
}

if (form) {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const bookingId = bookingIdInput.value;
        if (!bookingId) return;

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = 'Menyimpan...';

        const formData = new FormData(form);
        equipmentListDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            if (!cb.checked) {
                formData.delete(`quantity_${cb.value}`);
            }
        });

        try {
            let urlTemplate = "{% url 'update_booking' booking_id=99999 %}".replace('99999', bookingId);
            const response = await fetch(urlTemplate, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.success) {
                showUserToast(data.message || 'Booking berhasil diperbarui.', 'success');
                setTimeout(() => {
                    window.location.href = data.redirect_url || "{% url 'my_bookings' %}";
                }, 1000);
            } else {
                throw new Error(data.message || 'Terjadi kesalahan.');
            }

        } catch (error) {
            console.error('Error updating booking:', error);
            showUserToast(error.message, 'error');
            submitButton.disabled = false;
            submitButton.innerHTML = 'Simpan Perubahan';
        }
    });
}

const searchInput = document.getElementById('searchMyBooking');
const bookingListWrapper = document.getElementById('bookingListWrapper');
const dataUrl = "{% url 'my_bookings' %}"; 
let debounceTimer;
function debounce(func, delay) { return function(...args) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { func.apply(this, args); }, delay); }; }
async function fetchMyBookings() {
    const searchTerm = searchInput.value;
    const url = new URL(dataUrl, window.location.origin);
    if (searchTerm) url.searchParams.append('q', searchTerm);

    try {
        bookingListWrapper.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-teal-600 mb-4"></i><p class="text-gray-500 font-medium">Memuat bookingan Anda...</p></div>`;
        const response = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'text/html' } });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const html = await response.text();
        bookingListWrapper.innerHTML = html;
        window.history.replaceState({}, '', url.toString());
    } catch (error) {
        console.error('Error fetching my bookings:', error);
        bookingListWrapper.innerHTML = `<div class="text-center p-10 bg-red-50 text-red-700 rounded-lg border border-red-200"><p class="font-semibold mb-2">Oops! Gagal memuat data.</p><p class="text-sm">Silakan coba refresh halaman.</p></div>`;
    }
}
if (searchInput) { searchInput.addEventListener('input', debounce(fetchMyBookings, 350)); }

const deleteModal = document.getElementById('confirmDeleteModal');
const deleteVenueNameSpan = document.getElementById('deleteVenueName');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
let currentDeleteForm = null;

function closeDeleteModal() {
    if (deleteModal) {
        deleteModal.classList.add('hidden');
        currentDeleteForm = null;
    }
}

// --- Delete Booking Handler ---
document.addEventListener('submit', async function(e) {
    // Cek apakah yang disubmit adalah form delete booking
    if (e.target.classList.contains('delete-booking-form')) {
        e.preventDefault();
        
        currentDeleteForm = e.target;
        const bookingItem = currentDeleteForm.closest('li[id^="booking-item-"]');
        const venueName = bookingItem.querySelector('.text-orange-600').textContent.trim();
        
        // Set nama venue di modal
        deleteVenueNameSpan.textContent = venueName;
        
        // Tampilkan modal
        deleteModal.classList.remove('hidden');
    }
});

// Konfirmasi delete dari modal
if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', async function() {
        if (!currentDeleteForm) return;
        
        const bookingItem = currentDeleteForm.closest('li[id^="booking-item-"]');
        
        // Disable button saat loading
        const originalText = confirmDeleteBtn.innerHTML;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.innerHTML = '<svg class="w-5 h-5 mx-auto animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        
        try {
            const response = await fetch(currentDeleteForm.action, {
                method: 'POST',
                body: new FormData(currentDeleteForm),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            const data = await response.json();
            
            // Tutup modal terlebih dahulu
            closeDeleteModal();
            
            if (data.success) {
                showUserToast(data.message || 'Booking berhasil dibatalkan.', 'success');
                
                // Animasi fade out item yang dihapus
                bookingItem.style.transition = 'opacity 0.3s, transform 0.3s';
                bookingItem.style.opacity = '0';
                bookingItem.style.transform = 'translateX(-20px)';
                
                // Refresh list setelah animasi
                setTimeout(() => {
                    fetchMyBookings();
                }, 400);
            } else {
                throw new Error(data.message || 'Gagal membatalkan booking.');
            }
        } catch (error) {
            console.error('Error:', error);
            showUserToast(error.message || 'Terjadi kesalahan saat membatalkan booking.', 'error');
        } finally {
            // Restore button
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.innerHTML = originalText;
        }
    });
}

</script>
{% endblock extra_js %}